@page "/Chat"
@using HC.Localization
@using Volo.Abp.Features
@using Volo.Abp.Timing
@using HC.Chat
@using HC.Chat.Authorization
@using HC.Chat.Conversations
@using HC.Chat.Messages
@using Volo.Abp.AspNetCore.Components.Web
@using HC.Shared
@using HC.Projects
@using HC.ProjectTasks
@using HC.ProjectMembers
@using Microsoft.Extensions.Caching.Memory
@attribute [Authorize(ChatPermissions.Messaging)]
@attribute [RequiresFeature(ChatFeatures.Enable)]
@inherits HCComponentBase
@inject AbpBlazorMessageLocalizerHelper<HCResource> LH
@inject IClock Clock
@inject IMemoryCache __MemoryCache
@inject IProjectsAppService ProjectsAppService
@inject IProjectTasksAppService ProjectTasksAppService
@inject IProjectMembersAppService ProjectMembersAppService

<link href="_content/Volo.Chat.Blazor/libs/Index.css" rel="stylesheet"/>
<div id="chat_wrapper">
    <div class="container-fluid">
        <div class="row">
            <!-- Users box-->
            <div class="col-12 col-md-5 col-lg-4  d-flex align-items-stretch">
                <div class="card w-100 mb-3 mb-md-0" style="height: 100vh; display: flex; flex-direction: column;">
                    <div class="card-body p-1 p-md-2 p-lg-3" style="display: flex; flex-direction: column; overflow: hidden;">
                        <div class=" mb-2 rounded-2" id="SearchBox">
                            <div class="row">
                                <div class="col">
                                    <input type="search"
                                       @oninput="@((e) => { SearchValue = (string)e.Value;})"
                                       @onchange="@(async e => await OnSearchChangeAsync(e.Value?.ToString()))"
                                       @onkeyup="@(async e => await OnSearchKeyupAsync(e))"
                                       class="form-control form-control-sm"
                                       placeholder="@L["SearchInContacts"].Value"
                                       aria-label="@L["SearchInContacts"].Value"
                                       autocomplete="off" spellcheck="false"
                                       aria-autocomplete="list"
                                       role="combobox"
                                       aria-expanded="false"
                                       aria-owns="algolia-autocomplete-listbox-0"
                                       dir="auto">
                                </div>
                            </div>
                            <!-- Create Conversation Buttons -->
                            <div class="row mt-2">
                                <div class="col-12">
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-info" @onclick="async () => await ShowCreateDirectModalAsync()" title="@L["StartConversation"]">
                                            <i class="bi bi-person"></i> @L["User"]
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" @onclick="async () => await ShowCreateGroupModalAsync()" title="@L["CreateGroup"]">
                                            <i class="bi bi-people"></i> @L["Group"]
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-success" @onclick="async () => await ShowCreateProjectModalAsync()" title="@L["CreateProject"]">
                                            <i class="bi bi-folder"></i> @L["Project"]
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-warning" @onclick="async () => await ShowCreateTaskModalAsync()" title="@L["CreateTask"]">
                                            <i class="bi bi-check2-square"></i> @L["Task"]
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="messages-box lpx-ps-scroll-container m-0 p-0 ps ps--active-y" id="chat-messages-container" style="flex: 1; overflow-y: auto; min-height: 0;">
                            <div class="list-group rounded-3 contract-list" id="contact_list">
                                @{
                                    var otherContacts = false;
                                    foreach (var chatContact in ChatContactDtos)
                                    {
                                        if (chatContact.LastMessage.IsNullOrWhiteSpace() && !otherContacts)
                                        {
                                            <div class="list-group-item px-2 py-1 bg-light text-muted text-center font-size-sm text-uppercase border-start-0 border-end-0">
                                                <small>@L["OtherContacts"]</small>
                                            </div>

                                            otherContacts = true;
                                        }

                                        <a class="chat-contact cursor-pointer list-group-item list-group-item-action mb-1 mt-0 px-2 rounded-2 @(ChatContactsActive.ContainsKey(chatContact) ? ChatContactsActive[chatContact] : string.Empty)">
                                            <div class="media" @onclick="async () => await SetActiveAsync(chatContact)" >
                                                @* Conversation Type Icon *@
                                                <div class="me-2">
                                                    @if (chatContact.Type == ConversationType.Direct)
                                                    {
                                                        <canvas @ref="CanvasElementReferences[chatContact]" class="canvas-avatar mx-auto rounded-circle" Width="40" Height="40"></canvas>
                                                    }
                                                    else if (chatContact.Type == ConversationType.Group)
                                                    {
                                                        <i class="bi bi-people-fill fs-4 text-primary"></i>
                                                    }
                                                    else if (chatContact.Type == ConversationType.Project)
                                                    {
                                                        <i class="bi bi-folder-fill fs-4 text-success"></i>
                                                    }
                                                    else if (chatContact.Type == ConversationType.Task)
                                                    {
                                                        <i class="bi bi-check2-square fs-4 text-warning"></i>
                                                    }
                                                </div>
                                                <div class="media-body ms-2">
                                                    <div class="d-flex align-items-center justify-content-between mb-1">
                                                        <h6 class="mb-0 me-1">
                                                            @if (chatContact.UnreadMessageCount > 0)
                                                            {
                                                                <small class="badge bg-success me-1">@chatContact.UnreadMessageCount</small>
                                                            }
                                                            @if (chatContact.IsPinned)
                                                            {
                                                                <i class="bi bi-pin-fill text-warning me-1" title="@L["Pinned"]"></i>
                                                            }
                                                            @GetContactDisplayName(chatContact)
                                                        </h6>
                                                        @if (chatContact.LastMessageDate != null)
                                                        {
                                                            <div class="d-inline">
                                                                <small class="lh-1 d-block last-message-date">@Clock.ConvertToUserTime(chatContact.LastMessageDate.Value).ToString("d")</small>
                                                                <small class="lh-1 d-block last-message-date">@Clock.ConvertToUserTime(chatContact.LastMessageDate.Value).ToString("t")</small>
                                                            </div>
                                                        }
                                                    </div>
                                                    <p class="mb-0 small last-message">@chatContact.LastMessage.TruncateWithPostfix(36,"...")</p>
                                                    @if (chatContact.Type != ConversationType.Direct && chatContact.MemberCount > 0)
                                                    {
                                                        <small class="text-muted"><i class="bi bi-people"></i> @chatContact.MemberCount @L["Member"]</small>
                                                    }
                                                </div>
                                            </div>
                                            <div class="dropdown position-absolute bottom-0 end-0">
                                                <button class="btn p-1" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <i class="lpx-caret bi-chevron-down" aria-hidden="true"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    @if (chatContact.Type != ConversationType.Direct)
                                                    {
                                                        <li>
                                                            <a class="dropdown-item" @onclick="async () => await TogglePinConversationAsync(chatContact)">
                                                                @if (chatContact.IsPinned)
                                                                {
                                                                    <i class="bi bi-pin-angle"></i> @L["UnpinConversation"]
                                                                }
                                                                else
                                                                {
                                                                    <i class="bi bi-pin-fill"></i> @L["PinConversation"]
                                                                }
                                                            </a>
                                                        </li>
                                                    }
                                                    @if (IsDeletingConversationEnabled())
                                                    {
                                                        <li>
                                                            <a class="dropdown-item delete-conversation-btn" @onclick="async () => await DeleteConversationAsync()">@L["Delete"]</a>
                                                        </li>
                                                    }
                                                </ul>
                                            </div>
                                        </a>
                                    }
                                }
                                @* Load More Conversations Button *@
                                @if (_hasMoreConversations)
                                {
                                    <div class="list-group-item text-center py-2">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="LoadMoreConversationsAsync" disabled="@_isLoadingMoreConversations">
                                            @if (_isLoadingMoreConversations)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                            }
                                            @L["LoadMore"]
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Chat Box-->
            <div id="chatBox" class="col-12 col-md-7 col-lg-8  d-flex align-items-stretch" style="@ChatMessagesContainerStyle height: 100vh; display: flex; flex-direction: column;">
                <div class="card w-100 mb-0" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="card-body p-1 p-md-2 p-lg-3" style="display: flex; flex-direction: column; overflow: hidden; flex: 1;">
                        <div id="AvatarId" class="px-2 py-1 border mb-2 rounded-2">
                            <div class="row">
                                <div class="col-auto pe-0">
                                    @if (CurrentChatContact != null && CurrentChatContact.Type == ConversationType.Direct)
                                    {
                                        <canvas @ref="CurrentChatContactCanvas" class="rounded-circle mt-1" width="36" height="36"></canvas>
                                    }
                                    else if (CurrentChatContact != null)
                                    {
                                        @if (CurrentChatContact.Type == ConversationType.Group)
                                        {
                                            <i class="bi bi-people-fill fs-4 text-primary mt-1"></i>
                                        }
                                        else if (CurrentChatContact.Type == ConversationType.Project)
                                        {
                                            <i class="bi bi-folder-fill fs-4 text-success mt-1"></i>
                                        }
                                        else if (CurrentChatContact.Type == ConversationType.Task)
                                        {
                                            <i class="bi bi-check2-square fs-4 text-warning mt-1"></i>
                                        }
                                    }
                                </div>
                                <div class="col d-flex flex-column justify-content-center">
                                    <h5 id="Conversation_Title" class="m-0">
                                        @if (CurrentChatContact != null)
                                        {
                                            @if (CurrentChatContact.Type == ConversationType.Direct)
                                            {
                                                @(GetName(CurrentChatContact) + (CurrentChatContact.HasChatPermission ? string.Empty : $" - {L["Volo.Chat:010004"]}"))
                                            }
                                            else
                                            {
                                                @(CurrentChatContact.ConversationName ?? GetName(CurrentChatContact))
                                            }
                                        }
                                    </h5>
                                </div>
                            </div>
                        </div>
                        @if (IsLoadingMessages)
                        {
                            <div id="chatBox" class="card-body pt-12 pb-12 text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">@L["Loading"]</p>
                            </div>
                        }
                        else if (ChatConversationDto == null)
                        {
                            <div id="EmptyTemplate" class="card-body pt-12 pb-12 text-center">
                                <i class="fa fa-commenting-o fs-2" aria-hidden="true"></i>
                                <p>@L["NoMessageYetMessage"].Value</p>
                                <button id="StartConversation" @onclick="@(async () => await StartConversationAsync())" type="button" class="btn btn-primary">
                                    @L["StartConversation"]
                                </button>
                            </div>
                        }else{
                            <div id="chat_conversation_wrapper" class="chat-box mb-2" style="flex: 1; overflow-y: auto; min-height: 0;" @onscroll="OnConversationScroll">
                                <div class="chat-box-container" id="chat_conversation">
                                    @if (_isLoadingMoreMessages)
                                    {
                                        <div class="text-center py-2">
                                            <span class="spinner-border spinner-border-sm text-primary" role="status" aria-hidden="true"></span>
                                        </div>
                                    }
                                    @foreach (var message in ChatConversationDto.Messages)
                                    {
                                        if (message.Side == ChatMessageSide.Sender)
                                        {
                                            <div class="media w-75 mw-65 w-lp-auto mb-2 ms-auto position-relative">
                                                <div class="media-body position-relative ">
                                                    @* Reply to message *@
                                                    @if (message.ReplyToMessage != null)
                                                    {
                                                        <div class="bg-dark bg-opacity-25 rounded p-2 mb-1 position-relative" style="border-left: 3px solid #0d6efd; cursor: pointer;" @onclick="async () => await TogglePinMessageAsync(message.ReplyToMessage)" @onclick:stopPropagation="true" title="@L["ClickToPinUnpinMessage"]">
                                                            <div class="d-flex align-items-center justify-content-between">
                                                                <div class="flex-grow-1">
                                                                    <small class="text-muted d-block">@L["ReplyingTo"]:</small>
                                                                    <small class="text-truncate d-block">@message.ReplyToMessage.Message.TruncateWithPostfix(50, "...")</small>
                                                                </div>
                                                                @if (message.ReplyToMessage.IsPinned)
                                                                {
                                                                    <i class="bi bi-pin-fill text-warning ms-2" title="@L["Pinned"]"></i>
                                                                }
                                                                else
                                                                {
                                                                    <i class="bi bi-pin ms-2 text-muted" title="@L["ClickToPin"]"></i>
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                    <div class="bg-primary text-bg-primary card mb-1 px-2 px-lg-3 py-1 py-lg-2 rounded shadow-sm position-relative">
                                                        @if (message.IsSending)
                                                        {
                                                            <div class="position-absolute top-0 end-0 p-1">
                                                                <span class="spinner-border spinner-border-sm text-light" role="status" aria-hidden="true"></span>
                                                            </div>
                                                        }
                                                        <p class="mb-0 message-text text-small">@message.Message</p>
                                                        @* Message Files *@
                                                        @if (message.Files != null && message.Files.Any())
                                                        {
                                                            <div class="mt-2">
                                                                @foreach (var file in message.Files)
                                                                {
                                                                    <div class="d-flex align-items-center mb-1 p-1 bg-dark bg-opacity-25 rounded">
                                                                        <i class="bi bi-file-earmark me-2"></i>
                                                                        <small class="flex-grow-1 text-truncate">@file.FileName</small>
                                                                        <button class="btn btn-sm btn-link text-light p-0 ms-2" @onclick="async () => await DownloadFileAsync(file.Id)" title="@L["DownloadFile"]">
                                                                            <i class="bi bi-download"></i>
                                                                        </button>
                                                                    </div>
                                                                }
                                                            </div>
                                                        }
                                                        @if (message.IsPinned)
                                                        {
                                                            <div class="mt-1">
                                                                <small><i class="bi bi-pin-fill text-warning"></i> @L["Pinned"]</small>
                                                            </div>
                                                        }
                                                    </div>
                                                    <p class="left m-0 message-date small text-muted" style="opacity: 0.35; width: 150px; left: -110px; top: 1px; ">@Clock.ConvertToUserTime(message.MessageDate)</p>
                                                </div>

                                                <div class="dropdown position-absolute top-0 end-0">
                                                    <button class="btn p-1" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="bi bi-chevron-down text-light" aria-hidden="true"></i>
                                                    </button>
                                                    <ul class="dropdown-menu" style="">
                                                        <li>
                                                            <a class="dropdown-item" @onclick="async () => await ReplyToMessageAsync(message)">
                                                                <i class="bi bi-reply"></i> @L["Reply"]
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" @onclick="async () => await TogglePinMessageAsync(message)">
                                                                @if (message.IsPinned)
                                                                {
                                                                    <i class="bi bi-pin-angle"></i> @L["UnpinMessage"]
                                                                }
                                                                else
                                                                {
                                                                    <i class="bi bi-pin-fill"></i> @L["PinMessage"]
                                                                }
                                                            </a>
                                                        </li>
                                                        @if (IsDeletingMessageEnabled(message))
                                                        {
                                                            <li><hr class="dropdown-divider"></li>
                                                            <li>
                                                                <a class="dropdown-item delete-message-btn text-danger" @onclick="async () => await DeleteMessageAsync(message)">@L["Delete"]</a>
                                                            </li>
                                                        }
                                                    </ul>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="media w-75 mw-65 w-lp-auto mb-2">
                                                @* Avatar and sender name for Group/Project/Task conversations *@
                                                @if (CurrentChatContact != null && CurrentChatContact.Type != ConversationType.Direct && message.SenderUserId.HasValue)
                                                {
                                                    <div class="me-2">
                                                        <canvas id="sender-avatar-@message.Id" width="32" height="32" style="border-radius: 50%;"></canvas>
                                                    </div>
                                                }
                                                <div class="media-body position-relative ms-3">
                                                    @* Sender name for Group/Project/Task conversations *@
                                                    @if (CurrentChatContact != null && CurrentChatContact.Type != ConversationType.Direct && message.SenderUserId.HasValue)
                                                    {
                                                        <div class="mb-1">
                                                            <small class="text-muted fw-bold">
                                                                @if (!string.IsNullOrEmpty(message.SenderName) || !string.IsNullOrEmpty(message.SenderSurname))
                                                                {
                                                                    @($"{message.SenderName} {message.SenderSurname}".Trim())
                                                                }
                                                                else if (!string.IsNullOrEmpty(message.SenderUsername))
                                                                {
                                                                    @message.SenderUsername
                                                                }
                                                                else
                                                                {
                                                                    @L["UnknownUser"]
                                                                }
                                                            </small>
                                                        </div>
                                                    }
                                                    @* Reply to message *@
                                                    @if (message.ReplyToMessage != null)
                                                    {
                                                        <div class="bg-light rounded p-2 mb-1 position-relative" style="border-left: 3px solid #6c757d; cursor: pointer;" @onclick="async () => await TogglePinMessageAsync(message.ReplyToMessage)" @onclick:stopPropagation="true" title="@L["ClickToPinUnpinMessage"]">
                                                            <div class="d-flex align-items-center justify-content-between">
                                                                <div class="flex-grow-1">
                                                                    <small class="text-muted d-block">@L["ReplyingTo"]:</small>
                                                                    <small class="text-truncate d-block">@message.ReplyToMessage.Message.TruncateWithPostfix(50, "...")</small>
                                                                </div>
                                                                @if (message.ReplyToMessage.IsPinned)
                                                                {
                                                                    <i class="bi bi-pin-fill text-warning ms-2" title="@L["Pinned"]"></i>
                                                                }
                                                                else
                                                                {
                                                                    <i class="bi bi-pin ms-2 text-muted" title="@L["ClickToPin"]"></i>
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                    <div class="bg-light shadow rounded py-2 px-3 mb-1 position-relative">
                                                        @if (message.IsSending)
                                                        {
                                                            <div class="position-absolute top-0 end-0 p-1">
                                                                <span class="spinner-border spinner-border-sm text-muted" role="status" aria-hidden="true"></span>
                                                            </div>
                                                        }
                                                        <p class="text-small mb-0 text-muted">@message.Message</p>
                                                        @* Message Files *@
                                                        @if (message.Files != null && message.Files.Any())
                                                        {
                                                            <div class="mt-2">
                                                                @foreach (var file in message.Files)
                                                                {
                                                                    <div class="d-flex align-items-center mb-1 p-1 bg-white rounded border">
                                                                        <i class="bi bi-file-earmark me-2"></i>
                                                                        <small class="flex-grow-1 text-truncate">@file.FileName</small>
                                                                        <button class="btn btn-sm btn-link p-0 ms-2" @onclick="async () => await DownloadFileAsync(file.Id)" title="@L["DownloadFile"]">
                                                                            <i class="bi bi-download"></i>
                                                                        </button>
                                                                    </div>
                                                                }
                                                            </div>
                                                        }
                                                        @if (message.IsPinned)
                                                        {
                                                            <div class="mt-1">
                                                                <small><i class="bi bi-pin-fill text-warning"></i> @L["Pinned"]</small>
                                                            </div>
                                                        }
                                                    </div>
                                                    <p class="small text-muted position-absolute m-0" style="opacity: 0.35; width: 100px; right: -110px; top: 1px;">@Clock.ConvertToUserTime(message.MessageDate)</p>
                                                </div>

                                                <div class="dropdown position-absolute top-0 end-0">
                                                    <button class="btn p-1" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="bi bi-chevron-down text-muted" aria-hidden="true"></i>
                                                    </button>
                                                    <ul class="dropdown-menu" style="">
                                                        <li>
                                                            <a class="dropdown-item" @onclick="async () => await ReplyToMessageAsync(message)">
                                                                <i class="bi bi-reply"></i> @L["Reply"]
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" @onclick="async () => await TogglePinMessageAsync(message)">
                                                                @if (message.IsPinned)
                                                                {
                                                                    <i class="bi bi-pin-angle"></i> @L["UnpinMessage"]
                                                                }
                                                                else
                                                                {
                                                                    <i class="bi bi-pin-fill"></i> @L["PinMessage"]
                                                                }
                                                            </a>
                                                        </li>
                                                        @if (IsDeletingMessageEnabled(message))
                                                        {
                                                            <li><hr class="dropdown-divider"></li>
                                                            <li>
                                                                <a class="dropdown-item delete-message-btn text-danger" @onclick="async () => await DeleteMessageAsync(message)">@L["Delete"]</a>
                                                            </li>
                                                        }
                                                    </ul>
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        }

                        <!-- Typing area -->
                        @if (ChatConversationDto != null)
                        {
                            <div class="bg-light rounded-3 m-0">
                                <div class="p-2 p-lg-3">
                                    @* Reply Preview *@
                                    @if (ReplyingToMessage != null)
                                    {
                                        <div class="bg-info bg-opacity-10 rounded p-2 mb-2 d-flex justify-content-between align-items-center">
                                            <div class="flex-grow-1">
                                                <small class="text-muted d-block">@L["ReplyingTo"]:</small>
                                                <small class="text-truncate d-block">@ReplyingToMessage.Message.TruncateWithPostfix(50, "...")</small>
                                            </div>
                                            <button class="btn btn-sm btn-link p-0" @onclick="() => ReplyingToMessage = null">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    }
                                    @* Uploaded Files Preview *@
                                    @if (UploadedFiles != null && UploadedFiles.Any())
                                    {
                                        <div class="mb-2">
                                            @foreach (var file in UploadedFiles)
                                            {
                                                <div class="d-inline-block me-2 mb-1 p-2 bg-white rounded border">
                                                    <small class="d-block">@file.FileName</small>
                                                    <button class="btn btn-sm btn-link p-0 text-danger" @onclick="() => UploadedFiles.Remove(file)">
                                                        <i class="bi bi-x-circle"></i>
                                                    </button>
                                                </div>
                                            }
                                        </div>
                                    }
                                    <div class="d-flex align-items-start">
                                        <label class="btn btn-sm btn-outline-secondary me-2" title="@L["AttachFile"]" style="cursor: pointer;">
                                            <i class="bi bi-paperclip"></i>
                                            <InputFile OnChange="OnFileSelected" multiple class="d-none" />
                                        </label>
                                        <textarea @ref="MessageTextArea"
                                        @bind="Message"
                                        @bind:event="oninput"
                                        @onkeydown="@(async e => await OnMessageEntryAsync(e))"
                                        @onkeydown:preventDefault="@(e => e.Code == "Enter" && SendOnEnter && !_isSendingMessage)"
                                                    type="text" placeholder="@L["TypeMessage"].Value" class="form-control rounded py-2 flex-grow-1"></textarea>
                                    </div>
                                    <div class="form-check float-start mt-2">
                                        <input @bind="SendOnEnter" type="checkbox" class="form-check-input  border shadow-sm" id="Send_On_Enter">
                                        <label class="form-check-label" for="Send_On_Enter">@L["SendOnEnter"].Value</label>
                                    </div>
                                    <div class="mt-2 text-end">
                                        <button disabled="@(Message.IsNullOrWhiteSpace() && (UploadedFiles == null || !UploadedFiles.Any()))" @onclick="async () => await SendMessageAsync()" type="submit" class="btn btn-primary px-3">
                                            @L["Send"]
                                            <i class="fa fa-paper-plane ms-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Create Direct Conversation Modal *@
@if (ShowCreateDirectModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@L["StartConversation"]</h5>
                    <button type="button" class="btn-close" @onclick="() => ShowCreateDirectModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <Field>
                            <FieldLabel>@L["User"] *</FieldLabel>
                            <div class="hc-select2-full">
                                <Select2 IdSelector="c => c.Id.ToString()"
                                        TextSelector="c => c.DisplayName"
                                        FilterFunction="GetIdentityUserCollectionLookupAsync"
                                        GetElementById="async (items, id, token) => items.FirstOrDefault(x => x.Id.ToString() == id)!"
                                        Datasource="IdentityUsersCollection"
                                        Value="@SelectedDirectUser"
                                        ValueChanged="@((List<LookupDto<Guid>> value) => SelectedDirectUser = value ?? new List<LookupDto<Guid>>())"
                                        Cache="__MemoryCache"
                                        Multiselect="false" />
                            </div>
                        </Field>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => ShowCreateDirectModal = false">@L["Cancel"]</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateDirectConversationAsync">@L["StartConversation"]</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@* Create Group Modal *@
@if (ShowCreateGroupModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@L["CreateGroupChat"]</h5>
                    <button type="button" class="btn-close" @onclick="() => ShowCreateGroupModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">@L["GroupName"] *</label>
                        <input type="text" class="form-control" @bind="NewGroupName" maxlength="256" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">@L["Description"]</label>
                        <textarea class="form-control" @bind="NewGroupDescription" rows="3" maxlength="1000"></textarea>
                    </div>
                    <div class="mb-3">
                        <Field>
                            <FieldLabel>@L["Members"] *</FieldLabel>
                            <div class="hc-select2-full">
                                <Select2 IdSelector="c => c.Id.ToString()"
                                        TextSelector="c => c.DisplayName"
                                        FilterFunction="GetIdentityUserCollectionLookupAsync"
                                        GetElementById="async (items, id, token) => items.FirstOrDefault(x => x.Id.ToString() == id)!"
                                        Datasource="IdentityUsersCollection"
                                        Value="@SelectedMembers"
                                        ValueChanged="@((List<LookupDto<Guid>> value) => SelectedMembers = value ?? new List<LookupDto<Guid>>())"
                                        Cache="__MemoryCache"
                                        Multiselect="true" />
                            </div>
                        </Field>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => ShowCreateGroupModal = false">@L["Cancel"]</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateGroupConversationAsync">@L["Create"]</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@* Create Project Modal *@
@if (ShowCreateProjectModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@L["CreateProjectChat"]</h5>
                    <button type="button" class="btn-close" @onclick="() => ShowCreateProjectModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <Field>
                            <FieldLabel>@L["Project"] *</FieldLabel>
                            <div class="hc-select2-full">
                                <Select2 IdSelector="c => c.Id.ToString()"
                                        TextSelector="c => c.DisplayName"
                                        FilterFunction="GetProjectCollectionLookupAsync"
                                        GetElementById="async (items, id, token) => items.FirstOrDefault(x => x.Id.ToString() == id)!"
                                        Datasource="ProjectsCollection"
                                        Value="@SelectedProject"
                                        ValueChanged="@((List<LookupDto<Guid>> value) => SelectedProject = value ?? new List<LookupDto<Guid>>())"
                                        Cache="__MemoryCache"
                                        Multiselect="false" />
                            </div>
                        </Field>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">@L["ChatName"]</label>
                        <input type="text" class="form-control" @bind="NewProjectName" maxlength="256" />
                    </div>
                    <div class="mb-3">
                        <Field>
                            <FieldLabel>@L["Members"]</FieldLabel>
                            <div class="hc-select2-full">
                                <Select2 IdSelector="c => c.Id.ToString()"
                                        TextSelector="c => c.DisplayName"
                                        FilterFunction="GetIdentityUserCollectionLookupAsync"
                                        GetElementById="async (items, id, token) => items.FirstOrDefault(x => x.Id.ToString() == id)!"
                                        Datasource="IdentityUsersCollection"
                                        Value="@SelectedMembers"
                                        ValueChanged="@((List<LookupDto<Guid>> value) => SelectedMembers = value ?? new List<LookupDto<Guid>>())"
                                        Cache="__MemoryCache"
                                        Multiselect="true" />
                            </div>
                        </Field>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => ShowCreateProjectModal = false">@L["Cancel"]</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateProjectConversationAsync">@L["Create"]</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@* Create Task Modal *@
@if (ShowCreateTaskModal)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@L["CreateTaskChat"]</h5>
                    <button type="button" class="btn-close" @onclick="() => ShowCreateTaskModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <Field>
                            <FieldLabel>@L["Task"] *</FieldLabel>
                            <div class="hc-select2-full">
                                <Select2 IdSelector="c => c.Id.ToString()"
                                        TextSelector="c => c.DisplayName"
                                        FilterFunction="GetProjectTaskCollectionLookupAsync"
                                        GetElementById="async (items, id, token) => items.FirstOrDefault(x => x.Id.ToString() == id)!"
                                        Datasource="ProjectTasksCollection"
                                        Value="@SelectedTask"
                                        ValueChanged="@((List<LookupDto<Guid>> value) => SelectedTask = value ?? new List<LookupDto<Guid>>())"
                                        Cache="__MemoryCache"
                                        Multiselect="false" />
                            </div>
                        </Field>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">@L["ChatName"]</label>
                        <input type="text" class="form-control" @bind="NewTaskName" maxlength="256" />
                    </div>
                    <div class="mb-3">
                        <Field>
                            <FieldLabel>@L["Members"]</FieldLabel>
                            <div class="hc-select2-full">
                                <Select2 IdSelector="c => c.Id.ToString()"
                                        TextSelector="c => c.DisplayName"
                                        FilterFunction="GetIdentityUserCollectionLookupAsync"
                                        GetElementById="async (items, id, token) => items.FirstOrDefault(x => x.Id.ToString() == id)!"
                                        Datasource="IdentityUsersCollection"
                                        Value="@SelectedMembers"
                                        ValueChanged="@((List<LookupDto<Guid>> value) => SelectedMembers = value ?? new List<LookupDto<Guid>>())"
                                        Cache="__MemoryCache"
                                        Multiselect="true" />
                            </div>
                        </Field>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => ShowCreateTaskModal = false">@L["Cancel"]</button>
                    <button type="button" class="btn btn-primary" @onclick="CreateTaskConversationAsync">@L["Create"]</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}
