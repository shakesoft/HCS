@page "/project-detail"
@page "/project-detail/{ProjectId:guid}"
@attribute [Authorize(HCPermissions.Projects.Default)]
@using HC.Localization
@using HC.Permissions
@using HC.Projects
@using HC.ProjectMembers
@using HC.ProjectTasks
@using HC.Shared
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Caching.Memory
@using Blazorise
@using Blazorise.Components
@using Blazorise.DataGrid
@using Volo.Abp.AspNetCore.Components.Messages
@using Volo.Abp.AspNetCore.Components.Web.Theming.Layout
@using Volo.Abp.BlazoriseUI
@inherits HCComponentBase
@inject IProjectsAppService ProjectsAppService
@inject IProjectTasksAppService ProjectTasksAppService
@inject IProjectMembersAppService ProjectMembersAppService
@inject IUiMessageService UiMessageService
@inject IMemoryCache __MemoryCache

<PageHeader Title="@PageTitle" BreadcrumbItems="BreadcrumbItems">
</PageHeader>

@if (ProjectId == Guid.Empty)
{
    <Alert Color="Color.Warning">
        @L["NoDataAvailable"]
    </Alert>
}
else if (IsLoadingProject)
{
    <Card>
        <CardBody>
            <Row Class="w-100 align-items-center" Style="height: 150px;">
                <Column>
                    <RadarSpinner />
                </Column>
            </Row>
        </CardBody>
    </Card>
}
else if (CurrentProject is null)
{
    <Alert Color="Color.Danger">
        @L["NoDataAvailable"]
    </Alert>
}
else
{
    @* Top: Project information *@
    <Card Class="mb-3">
        <CardBody>
            <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
                <div>
                    <h3 class="mb-1">@CurrentProject.Project.Name</h3>
                    <div class="text-muted">
                        <span class="me-2"><i class="fa fa-hashtag me-1"></i>@CurrentProject.Project.Code</span>
                        @if (CurrentProject.OwnerDepartment is not null)
                        {
                            <span class="me-2"><i class="fa fa-building me-1"></i>@CurrentProject.OwnerDepartment.Name</span>
                        }
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <Badge Color="Color.Primary">@L[$"Enum:ProjectStatus.{CurrentProject.Project.Status}"]</Badge>
                    <Badge Color="Color.Light">
                        <i class="fa fa-users me-1"></i>@CurrentProject.ProjectMemberCount
                    </Badge>
                    <Badge Color="Color.Light">
                        <i class="fa fa-list-check me-1"></i>@CurrentProject.ProjectTaskCount
                    </Badge>
                </div>
            </div>

            @if (!string.IsNullOrWhiteSpace(CurrentProject.Project.Description))
            {
                <div class="mt-3">
                    <Field>
                        <FieldLabel>@L["Description"]</FieldLabel>
                        <div class="hc-project-desc">
                            @CurrentProject.Project.Description
                        </div>
                    </Field>
                </div>
            }

            <Row Class="g-3 mt-1">
                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                    <Field>
                        <FieldLabel>@L["StartDate"]</FieldLabel>
                        <div class="hc-project-meta">
                            <i class="fa fa-calendar-day me-1"></i>@CurrentProject.Project.StartDate.ToString("dd/MM/yyyy HH:mm")
                        </div>
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                    <Field>
                        <FieldLabel>@L["EndDate"]</FieldLabel>
                        <div class="hc-project-meta">
                            <i class="fa fa-calendar-check me-1"></i>@CurrentProject.Project.EndDate.ToString("dd/MM/yyyy HH:mm")
                        </div>
                    </Field>
                </Column>
            </Row>
        </CardBody>
    </Card>

    @* Bottom: Tabs *@
    <Card>
        <CardBody>
            <Tabs SelectedTab="@SelectedTab" SelectedTabChanged="@OnSelectedTabChanged">
                <Items>
                    <Tab Name="tasks">@L["Tasks"]</Tab>
                    <Tab Name="members">@L["Members"]</Tab>
                </Items>
                <Content>
                    <TabPanel Name="tasks">
                        <div class="hc-tab-toolbar">
                            <Row Class="g-2 align-items-center">
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is8.OnDesktop">
                                    <TextEdit @bind-Text="TasksFilterText"
                                              Placeholder="@L["Search"]"
                                              Class="w-100" />
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                                    <div class="d-flex gap-2">
                                        <Button Color="Color.Primary" Size="Size.Small" Clicked="SearchTasksAsync" Class="w-100">
                                            <Icon Name="IconName.Search" Class="me-1" /> @L["Search"]
                                        </Button>
                                        <Button Color="Color.Light" Size="Size.Small" Outline Clicked="RefreshTasksAsync" Title="@L["Search"]">
                                            <Icon Name="IconName.Sync" />
                                        </Button>
                                    </div>
                                </Column>
                            </Row>
                        </div>

                        <DataGrid TItem="ProjectTaskWithNavigationPropertiesDto"
                                  @ref="TasksDataGridRef"
                                  Data="TasksList"
                                  ReadData="OnTasksGridReadAsync"
                                  TotalItems="TasksTotalCount"
                                  ShowPager="true"
                                  Responsive="true"
                                  PageSize="PageSize">
                            <LoadingTemplate>
                                <Row Class="w-100 align-items-center" Style="height: 120px;">
                                    <Column>
                                        <RadarSpinner />
                                    </Column>
                                </Row>
                            </LoadingTemplate>
                            <EmptyTemplate>
                                <Row Class="w-100 align-items-center" Style="height: 120px;">
                                    <Column>
                                        <Heading Size="HeadingSize.Is5" TextAlignment="TextAlignment.Center">@L["NoDataAvailable"]</Heading>
                                    </Column>
                                </Row>
                            </EmptyTemplate>
                            <DataGridColumns>
                                <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto" Field="ProjectTask.Code" Caption="@L["Code"]" />
                                <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto" Field="ProjectTask.Title" Caption="@L["Title"]">
                                    <DisplayTemplate>
                                        @if (!string.IsNullOrWhiteSpace(context.ProjectTask.ParentTaskId))
                                        {
                                            <div class="text-muted">
                                                @L["ParentTaskTitle"]: #@context.ProjectTask.ParentTaskId - @context.ParentTaskTitle
                                            </div>
                                        }
                                        <div class="d-flex align-items-center gap-2">
                                            <span>@context.ProjectTask.Title</span>
                                            @if (context.ChildTaskCount > 0)
                                            {
                                                <span class="text-muted">
                                                    <i aria-hidden="true" class="fa fa-list me-1"></i>@context.ChildTaskCount
                                                </span>
                                            }
                                        </div>
                                    </DisplayTemplate>
                                </DataGridColumn>
                                <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto" Field="ProjectTask.StartDate" Caption="@L["StartDate"]">
                                    <DisplayTemplate>
                                        @context.ProjectTask.StartDate.ToString("dd/MM/yyyy HH:mm")
                                    </DisplayTemplate>
                                </DataGridColumn>
                                <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto" Field="ProjectTask.DueDate" Caption="@L["DueDate"]">
                                    <DisplayTemplate>
                                        @context.ProjectTask.DueDate.ToString("dd/MM/yyyy HH:mm")
                                    </DisplayTemplate>
                                </DataGridColumn>
                                <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto" Field="ProjectTask.Status" Caption="@L["Status"]">
                                    <DisplayTemplate>
                                        <Badge Color="@GetStatusBadgeColor(ParseStatus(context.ProjectTask.Status))">
                                            @GetStatusText(ParseStatus(context.ProjectTask.Status))
                                        </Badge>
                                    </DisplayTemplate>
                                </DataGridColumn>
                                <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto" Field="ProjectTask.Priority" Caption="@L["Priority"]">
                                    <DisplayTemplate>
                                        <Badge Color="@GetPriorityBadgeColor(ParsePriority(context.ProjectTask.Priority))">
                                            @GetPriorityText(ParsePriority(context.ProjectTask.Priority))
                                        </Badge>
                                    </DisplayTemplate>
                                </DataGridColumn>
                                <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto" Field="ProjectTask.ProgressPercent" Caption="@L["ProgressPercent"]">
                                    <DisplayTemplate>
                                        <div class="d-flex align-items-center gap-2">
                                            <Progress Value="@context.ProjectTask.ProgressPercent" Max="100" Class="hc-progress" />
                                            <span class="text-muted small">@context.ProjectTask.ProgressPercent%</span>
                                        </div>
                                    </DisplayTemplate>
                                </DataGridColumn>
                            </DataGridColumns>
                        </DataGrid>
                    </TabPanel>

                    <TabPanel Name="members">
                        <div class="hc-tab-toolbar">
                            <Row Class="g-2 mb-2 align-items-center">
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is8.OnDesktop">
                                    <TextEdit @bind-Text="MembersFilterText"
                                              Placeholder="@L["Search"]"
                                              Class="w-100" />
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                                    <Button Color="Color.Primary" Size="Size.Medium" Clicked="SearchMembersAsync" Class="w-100">
                                        <Icon Name="IconName.Search" Class="me-1" /> @L["Search"]
                                    </Button>
                                </Column>
                            </Row>

                            @if (CanCreateProjectMember)
                            {
                                <Row Class="g-2 mb-2 align-items-center">
                                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                                        <div class="hc-select2-full @(IsMemberRoleEditMode ? "hc-disabled" : string.Empty)">
                                            <Select2 IdSelector="c => c.Id.ToString()"
                                                     TextSelector="c => c.DisplayName"
                                                     FilterFunction="GetIdentityUserCollectionLookupAsync"
                                                     GetElementById="async (items, id, token) => items.FirstOrDefault(x => x.Id.ToString() == id)!"
                                                     Datasource="IdentityUsersCollection"
                                                     Value="@MembersToAdd"
                                                     OnValueChanged="OnMembersToAddChanged"
                                                     Cache="__MemoryCache"
                                                     Multiselect="false" />
                                        </div>
                                    </Column>
                                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                                        <Select TValue="ProjectMemberRole" @bind-SelectedValue="MembersRoleToAdd" Class="w-100">
                                            @foreach (var role in Enum.GetValues<ProjectMemberRole>())
                                            {
                                                <SelectItem TValue="ProjectMemberRole" Value="@role">
                                                    @L[$"Enum:ProjectMemberRole.{role}"]
                                                </SelectItem>
                                            }
                                        </Select>
                                    </Column>
                                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                                        <Button Color="Color.Primary"
                                                Size="Size.Medium"
                                                Disabled="@((!IsMemberRoleEditMode && (MembersToAdd == null || MembersToAdd.Count == 0)) || (IsMemberRoleEditMode && !CanEditProjectMember))"
                                                Clicked="AddOrUpdateMemberAsync"
                                                Class="w-100">
                                            @if (IsMemberRoleEditMode)
                                            {
                                                <Icon Name="IconName.Save" Class="me-1" /> @L["Update"]
                                            }
                                            else
                                            {
                                                <Icon Name="IconName.Add" Class="me-1" /> @L["Add"]
                                            }
                                        </Button>
                                    </Column>
                                </Row>
                            }
                        </div>

                        <DataGrid TItem="ProjectMemberWithNavigationPropertiesDto"
                                  @ref="MembersDataGridRef"
                                  Data="MembersList"
                                  ReadData="OnMembersGridReadAsync"
                                  TotalItems="MembersTotalCount"
                                  ShowPager="true"
                                  Responsive="true"
                                  PageSize="PageSize">
                            <LoadingTemplate>
                                <Row Class="w-100 align-items-center" Style="height: 120px;">
                                    <Column>
                                        <RadarSpinner />
                                    </Column>
                                </Row>
                            </LoadingTemplate>
                            <EmptyTemplate>
                                <Row Class="w-100 align-items-center" Style="height: 120px;">
                                    <Column>
                                        <Heading Size="HeadingSize.Is5" TextAlignment="TextAlignment.Center">@L["NoDataAvailable"]</Heading>
                                    </Column>
                                </Row>
                            </EmptyTemplate>
                            <DataGridColumns>
                                <DataGridColumn TItem="ProjectMemberWithNavigationPropertiesDto" Field="User.UserName" Caption="@L["UserName"]" />
                                <DataGridColumn TItem="ProjectMemberWithNavigationPropertiesDto" Field="ProjectMember.MemberRole" Caption="@L["MemberRole"]">
                                    <DisplayTemplate>
                                        <Badge Color="Color.Primary">@L[$"Enum:ProjectMemberRole.{context.ProjectMember.MemberRole}"]</Badge>
                                    </DisplayTemplate>
                                </DataGridColumn>
                                <DataGridColumn TItem="ProjectMemberWithNavigationPropertiesDto" Field="ProjectMember.JoinedAt" Caption="@L["JoinedAt"]">
                                    <DisplayTemplate>
                                        @context.ProjectMember.JoinedAt.ToString("dd/MM/yyyy HH:mm")
                                    </DisplayTemplate>
                                </DataGridColumn>
                                @if (CanEditProjectMember || CanDeleteProjectMember)
                                {
                                    <DataGridColumn TItem="ProjectMemberWithNavigationPropertiesDto" Caption="@L["Actions"]">
                                        <DisplayTemplate>
                                            <div class="d-flex gap-2 flex-wrap justify-content-end">
                                                @if (CanEditProjectMember)
                                                {
                                                    <Button Color="Color.Primary" Outline Size="Size.Small" Clicked="@(() => ToggleEditMemberRoleAsync(context))">
                                                        @(IsMemberRoleEditMode && EditingMemberId == context.ProjectMember.Id ? L["Cancel"].Value : L["Edit"].Value)
                                                    </Button>
                                                }
                                                @if (CanDeleteProjectMember)
                                                {
                                                    <Button Color="Color.Danger" Outline Size="Size.Small" Clicked="@(() => DeleteMemberAsync(context))">
                                                        <Icon Name="IconName.Delete" Class="me-1" /> @L["Delete"]
                                                    </Button>
                                                }
                                            </div>
                                        </DisplayTemplate>
                                    </DataGridColumn>
                                }
                            </DataGridColumns>
                        </DataGrid>
                    </TabPanel>
                </Content>
            </Tabs>
        </CardBody>
    </Card>
}

<style>
    .hc-project-desc {
        padding: .75rem 1rem;
        background: rgba(13,110,253,.02);
        white-space: pre-wrap;
    }

    .hc-project-meta {
        padding: .35rem 0;
    }

    .hc-tab-toolbar {
        margin-bottom: .75rem;
    }

    .hc-progress {
        width: 140px;
        height: 8px;
    }

    /* Make select2 always full width */
    .hc-select2-full,
    .hc-select2-full > * {
        width: 100%;
        max-width: 100%;
    }

    .hc-select2-full .select2-container {
        width: 100% !important;
    }

    .hc-disabled {
        pointer-events: none;
        opacity: 0.75;
    }

    @@media (max-width: 576px) {
        .hc-progress {
            width: 100px;
        }
    }
</style>

