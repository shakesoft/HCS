@page "/departments"
@attribute [Authorize(HCPermissions.Departments.Default)]
@using HC.Departments
@using HC.Localization
@using HC.Shared
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Localization
@using Microsoft.AspNetCore.Components.Web
@using Blazorise
@using Blazorise.Components
@using Blazorise.DataGrid
@using Volo.Abp.BlazoriseUI
@using Volo.Abp.BlazoriseUI.Components
@using Volo.Abp.ObjectMapping
@using Volo.Abp.AspNetCore.Components.Messages
@using Volo.Abp.AspNetCore.Components.Web.Theming.Layout
@using HC.Permissions
@using Volo.Abp.AspNetCore.Components.Web
@using Volo.Abp.AspNetCore.Components
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Caching.Memory
@using Volo.Abp.Http.Client
@using Excubo.Blazor.TreeViews
@inherits HCComponentBase
@inject IDepartmentsAppService DepartmentsAppService
@inject IUiMessageService UiMessageService
@inject AbpBlazorMessageLocalizerHelper<HCResource> LH
@inject IRemoteServiceConfigurationProvider RemoteServiceConfigurationProvider
@inject NavigationManager NavigationManager
@inject IMemoryCache __MemoryCache

@* ************************* PAGE HEADER ************************* *@
<PageHeader Title="@L["Departments"]" BreadcrumbItems="BreadcrumbItems" Toolbar="Toolbar">
</PageHeader>

<Row>
    <Column ColumnSize="ColumnSize.Is6">
        <Card>
            <CardHeader>
                <Row Class="justify-content-between">
                    <Column ColumnSize="ColumnSize.IsAuto">
                        <Heading Size="HeadingSize.Is4">
                            @L["DepartmentTree"]
                        </Heading>
                    </Column>

                    @* @if (CanCreateDepartment)
                    {
                        <Column ColumnSize="ColumnSize.IsAuto">
                            <Button Clicked="() => OpenCreateDepartmentModal()" Color="Color.Primary">
                                <Icon Name="IconName.Add" Margin="Margin.Is1.FromEnd"></Icon>@L["AddRootDepartment"]
                            </Button>
                        </Column>
                    } *@
                </Row>
            </CardHeader>
            <CardBody>
                @if (DepartmentTreeViews == null || !DepartmentTreeViews.Any())
                {
                    @L["NoDepartmentDefinedYet"]
                }
                else
                {
                    <TreeView Items="DepartmentTreeViews"
                              GetChildren="@(item => item.Children)"
                              HasChildren="@(item => item.HasChildren)">
                        <ItemTemplate>
                            <Excubo.Blazor.TreeViews.Collapse @bind-Value="@context.Item.Collapsed"/>
                            <Dropdown>
                                <span class="ml-1 mr-1 @(SelectedDepartment?.Id == context.Item.Id ? "text-primary" : "")" style="cursor: pointer" @onclick="() => OnSelectedDepartmentNodeChangedAsync(context.Item)">
                                    &nbsp;<i class="fas fa-person-shelter"></i>&nbsp;
                                    @context.Item.Name
                                </span>
                                <DropdownToggle Padding="Padding.Is0" Color="Color.Default" Size="Size.ExtraSmall" Split="true"/>
                                <DropdownMenu>
                                    @if (CanCreateDepartment)
                                    {
                                        <DropdownItem Style="cursor: pointer" Clicked="() => OpenCreateDepartmentModal(context.Item)">
                                            @L["AddSubDepartment"]
                                        </DropdownItem>
                                    }
                                    @if (CanEditDepartment)
                                    {
                                        <DropdownItem Style="cursor: pointer" Clicked="() => OpenEditDepartmentModal(context.Item)">
                                            @L["Edit"]
                                        </DropdownItem>
                                        <DropdownItem Style="cursor: pointer" Clicked="() => OpenMoveDepartmentModal(context.Item)">
                                            @L["Move"]
                                        </DropdownItem>
                                    }
                                    @if (CanDeleteDepartment)
                                    {
                                        <DropdownItem Style="cursor: pointer;" Clicked="() => OpenDeleteDepartmentModalAsync(context.Item)">
                                            @L["Delete"]
                                        </DropdownItem>
                                    }
                                </DropdownMenu>
                            </Dropdown>
                        </ItemTemplate>
                    </TreeView>
                }
            </CardBody>
        </Card>
    </Column>

    <Column ColumnSize="ColumnSize.Is6">
        <Card>
            <CardHeader>
                @if (string.IsNullOrWhiteSpace(SelectedDepartment?.Name))
                {
                    <span>@L["AllDepartments"]</span>
                }
                else
                {
                    <span>@SelectedDepartment.Name @L["Details"].Value.ToLower()</span>
                }
            </CardHeader>
            <CardBody>
                <Field>
                    <FieldLabel>@L["ParentDepartment"]</FieldLabel>
                    <TextEdit @bind-Text="@ParentDepartmentName" Disabled="true" />
                </Field>

                <Field>
                    <FieldLabel>@L["Code"]</FieldLabel>
                    <TextEdit @bind-Text="@SelectedDepartmentCode" Disabled="true" />
                </Field>
                <Field>
                    <FieldLabel>@L["Name"]</FieldLabel>
                    <TextEdit @bind-Text="@SelectedDepartmentName" Disabled="true" />
                </Field>
                <Field>
                    <FieldLabel>@L["Level"]</FieldLabel>
                    <NumericEdit TValue="int" @bind-Value="@SelectedDepartmentLevel" Disabled="true" />
                </Field>
                <Field>
                    <FieldLabel>@L["SortOrder"]</FieldLabel>
                    <NumericEdit TValue="int" @bind-Value="@SelectedDepartmentSortOrder" Disabled="true" />
                </Field>
                <Field>
                    <FieldLabel>@L["IsActive"]</FieldLabel>
                    <Check TValue="bool" Checked="@(SelectedDepartment?.IsActive ?? false)" Disabled="true" />
                </Field>
            </CardBody>
        </Card>
    </Column>
</Row>

@* ************************* CREATE MODAL ************************* *@
<Modal @ref="CreateDepartmentModal" Closing="@CreateDepartmentModal.CancelClosingModalWhenFocusLost">
    <ModalContent Centered="true">
        <Form id="CreateDepartmentForm">
            <ModalHeader>
                <ModalTitle>@L["NewDepartment"]</ModalTitle>
                <CloseButton Clicked="CloseCreateDepartmentModalAsync" />
            </ModalHeader>
            <ModalBody>
                <Validations @ref="@NewDepartmentValidations"
                            Mode="ValidationMode.Auto"
                            Model="@NewDepartment"
                            ValidateOnLoad="false">
                    <Validation MessageLocalizer="@LH.Localize">
                        <Field>
                            <FieldLabel>@L["ParentDepartment"]</FieldLabel>
                            <Select TValue="string?" @bind-SelectedValue="@NewDepartment.ParentId">
                                <SelectItem TValue="string?" Value="null">@L["Root"]</SelectItem>
                                @if (AllDepartmentsForSelect2 != null && AllDepartmentsForSelect2.Any())
                                {
                                    @foreach (var department in AllDepartmentsForSelect2.Where(d => d.Id != Guid.Empty))
                                    {
                                        <SelectItem TValue="string" Value="@department.Id.ToString()">
                                            @GetDepartmentDisplayName(department)
                                        </SelectItem>
                                    }
                                }
                            </Select>
                        </Field>
                    </Validation>
                    
                    <Validation MessageLocalizer="@LH.Localize">
                        <Field>
                            <FieldLabel>@L["Code"] *</FieldLabel>
                            <TextEdit @bind-Text="@NewDepartment.Code" MaxLength="DepartmentConsts.CodeMaxLength" Autofocus="true">
                                <Feedback>
                                    <ValidationError />
                                </Feedback>
                            </TextEdit>
                        </Field>
                    </Validation>
                    <Validation MessageLocalizer="@LH.Localize">
                        <Field>
                            <FieldLabel>@L["Name"] *</FieldLabel>
                            <TextEdit @bind-Text="@NewDepartment.Name">
                                <Feedback>
                                    <ValidationError />
                                </Feedback>
                            </TextEdit>
                        </Field>
                    </Validation>
                    <Field>
                        <FieldLabel>@L["HeadOfDepartment"]</FieldLabel>
                        <Select2 IdSelector="c => c.Id.ToString()"
                                    TextSelector="c => c.DisplayName"
                                    FilterFunction="GetIdentityUserCollectionLookupAsync"
                                    GetElementById="async (items, id, token) => items.Where(x => x.Id.ToString() == id).FirstOrDefault()"
                                    Datasource="IdentityUsersCollection"
                                    Value="@SelectedLeaderUser"
                                    OnValueChanged="OnLeaderUserIdChanged"                
                                    Cache="__MemoryCache"
                                    Multiselect="false" />
                    </Field>
                    <Validation MessageLocalizer="@LH.Localize">
                        <Field>
                            <FieldLabel>@L["Level"]</FieldLabel>
                            <NumericPicker TValue="int" @bind-Value="@NewDepartment.Level" Decimals="0">
                                <Feedback>
                                    <ValidationError />
                                </Feedback>
                             </NumericPicker>
                        </Field>
                     </Validation>
                    <Validation MessageLocalizer="@LH.Localize">
                        <Field>
                            <FieldLabel>@L["SortOrder"]</FieldLabel>
                            <NumericPicker TValue="int" @bind-Value="@NewDepartment.SortOrder" Decimals="0">
                                <Feedback>
                                    <ValidationError />
                                </Feedback>
                             </NumericPicker>
                        </Field>
                     </Validation>
                    <Field>
                        <Check TValue="bool" @bind-Checked="@NewDepartment.IsActive">@L["IsActive"]</Check>
                    </Field>
                </Validations>
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary"
                        Clicked="CloseCreateDepartmentModalAsync">
                    @L["Cancel"]
                </Button>
                <SubmitButton Form="CreateDepartmentForm" Clicked="CreateDepartmentAsync"/>
            </ModalFooter>
        </Form>
    </ModalContent>
</Modal>

@* ************************* EDIT MODAL ************************* *@
<Modal @ref="EditDepartmentModal" Closing="@EditDepartmentModal.CancelClosingModalWhenFocusLost">
    <ModalContent Centered="true">
        <Form id="EditDepartmentForm">
            <ModalHeader>
                <ModalTitle>@L["Update"]</ModalTitle>
                <CloseButton Clicked="CloseEditDepartmentModalAsync" />
            </ModalHeader>
            <ModalBody>
                <Validations @ref="@EditingDepartmentValidations"
                            Mode="ValidationMode.Auto"
                            Model="@EditingDepartment"
                            ValidateOnLoad="false">
                    <Validation MessageLocalizer="@LH.Localize">
                        <Field>
                            <FieldLabel>@L["Code"] *</FieldLabel>
                            <TextEdit @bind-Text="@EditingDepartment.Code" MaxLength="DepartmentConsts.CodeMaxLength" Autofocus="true">
                                <Feedback>
                                    <ValidationError />
                                </Feedback>
                            </TextEdit>
                        </Field>
                    </Validation>
                    <Validation MessageLocalizer="@LH.Localize">
                        <Field>
                            <FieldLabel>@L["Name"] *</FieldLabel>
                            <TextEdit @bind-Text="@EditingDepartment.Name">
                                <Feedback>
                                    <ValidationError />
                                </Feedback>
                            </TextEdit>
                        </Field>
                    </Validation>
                    <Validation MessageLocalizer="@LH.Localize">
                        <Field>
                            <FieldLabel>@L["ParentDepartment"]</FieldLabel>
                            <Select TValue="string?" @bind-SelectedValue="@EditingDepartment.ParentId">
                                <SelectItem TValue="string?" Value="null">@L["Root"]</SelectItem>
                                @if (DepartmentTreeViews != null)
                                {
                                    @foreach (var department in DepartmentTreeViews)
                                    {
                                        <SelectItem TValue="string" Value="@department.Id.ToString()">
                                            @department.Name
                                        </SelectItem>
                                    }
                                }
                            </Select>
                        </Field>
                    </Validation>
                    <Field>
                        <FieldLabel>@L["HeadOfDepartment"]</FieldLabel>
                        <Select TValue="Guid?" @bind-SelectedValue="@EditingDepartment.LeaderUserId">
                            <SelectItem TValue="Guid?" Value="null"></SelectItem>
                            @foreach (var identityUser in IdentityUsersCollection)
                            {
                                <SelectItem TValue="Guid?" Value="@(identityUser.Id)">
                                    @(identityUser.DisplayName)
                                </SelectItem>
                            }
                        </Select>
                    </Field>
                    <Validation MessageLocalizer="@LH.Localize">
                        <Field>
                            <FieldLabel>@L["Level"]</FieldLabel>
                            <NumericPicker TValue="int" @bind-Value="@EditingDepartment.Level" Decimals="0">
                                <Feedback>
                                    <ValidationError />
                                </Feedback>
                             </NumericPicker>
                        </Field>
                     </Validation>
                    <Validation MessageLocalizer="@LH.Localize">
                        <Field>
                            <FieldLabel>@L["SortOrder"]</FieldLabel>
                            <NumericPicker TValue="int" @bind-Value="@EditingDepartment.SortOrder" Decimals="0">
                                <Feedback>
                                    <ValidationError />
                                </Feedback>
                             </NumericPicker>
                        </Field>
                     </Validation>
                    <Field>
                        <Check TValue="bool" @bind-Checked="@EditingDepartment.IsActive">@L["IsActive"]</Check>
                    </Field>
                </Validations>
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary"
                        Clicked="CloseEditDepartmentModalAsync">
                    @L["Cancel"]
                </Button>
                <SubmitButton Form="EditDepartmentForm" Clicked="UpdateDepartmentAsync" />
            </ModalFooter>
        </Form>
    </ModalContent>
</Modal>

@* ************************* MOVE MODAL ************************* *@
<Modal @ref="MoveDepartmentModal">
    <ModalContent Centered="true">
        <ModalHeader>
            <ModalTitle>@L["MoveDepartment", MovingDepartment?.Name]</ModalTitle>
            <CloseButton Clicked="CloseMoveDepartmentModal"/>
        </ModalHeader>
        <ModalBody>
            <Validations Mode="ValidationMode.Auto" Model="@MoveDepartmentModal" ValidateOnLoad="false">
                @if (MovableDepartmentTree == null || !MovableDepartmentTree.Any())
                {
                    @L["NoDepartmentDefinedYet"]
                }
                else
                {
                    <TreeView Items="MovableDepartmentTree"
                              GetChildren="@(item => item.Children)"
                              HasChildren="@(item => item.HasChildren)">
                        <ItemTemplate>
                            <Excubo.Blazor.TreeViews.Collapse @bind-Value="@context.Item.Collapsed"/>
                            <span
                                class="ml-1 mr-1 @(NewParentDepartment == context.Item ? "text-primary" : "")"
                                style="cursor: pointer"
                                @onclick="() => MovableDepartmentSelected(context.Item)">
                                @context.Item.Name
                            </span>
                        </ItemTemplate>
                    </TreeView>
                }
            </Validations>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="CloseMoveDepartmentModal">@L["Cancel"]</Button>
            <Button Color="Color.Primary" Clicked="MoveDepartmentAsync"><i class="fa-check fa"></i> @L["Save"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

