@page "/tasks"
@attribute [Authorize(HCPermissions.ProjectTasks.Default)]
@using HC.ProjectTasks
@using HC.Localization
@using HC.Shared
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Localization
@using Microsoft.AspNetCore.Components.Web
@using Blazorise
@using Blazorise.Components
@using Blazorise.DataGrid
@using Volo.Abp.BlazoriseUI
@using Volo.Abp.BlazoriseUI.Components
@using Volo.Abp.ObjectMapping
@using Volo.Abp.AspNetCore.Components.Messages
@using Volo.Abp.AspNetCore.Components.Web.Theming.Layout
@using HC.Permissions
@using Volo.Abp.AspNetCore.Components.Web
@using Volo.Abp.AspNetCore.Components
@using Microsoft.AspNetCore.Components
@using Volo.Abp.Http.Client
@using Microsoft.Extensions.Caching.Memory
@using HC.ProjectTaskAssignments
@using HC.ProjectTaskDocuments
@inherits HCComponentBase
@inject IProjectTasksAppService ProjectTasksAppService
@inject IUiMessageService UiMessageService
@inject AbpBlazorMessageLocalizerHelper<HCResource> LH
@inject IRemoteServiceConfigurationProvider RemoteServiceConfigurationProvider
@inject NavigationManager NavigationManager
@inject IMemoryCache __MemoryCache
@* ************************* PAGE HEADER ************************* *@
<PageHeader Title="@L["Menu:Tasks"]" BreadcrumbItems="BreadcrumbItems" Toolbar="Toolbar" @key="IsKanbanView">
</PageHeader>
<style>
    tr.table-row-selectable:hover {
        cursor: default;
    }

    .hc-progress {
        width: 140px;
        height: 8px;
    }

    @@media (max-width: 576px) {
        .hc-progress {
            width: 100px;
        }
    }
</style>

@if (IsKanbanView)
{
    <style>
        .hc-kanban-board {
            overflow-x: auto;
            position: relative;
        }

        /* Show loading overlay while updating via drag-drop */
        .hc-kanban-loading {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, .72);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: all;
        }

        .hc-kanban-column {
            min-width: 280px;
            max-width: 320px;
        }

        .hc-kanban-zone {
            min-height: 420px;
            background: #f7f9fc;
            border: 1px solid rgba(0,0,0,.08);
            border-radius: .75rem;
            padding: .5rem;
        }

        .hc-kanban-card {
            cursor: grab;
        }

        .hc-kanban-card:active {
            cursor: grabbing;
        }

        .hc-kanban-muted {
            color: rgba(0,0,0,.55);
        }

        .hc-avatar-stack {
            display: flex;
            align-items: center;
        }

        .hc-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #6c757d;
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: .75rem;
            font-weight: 600;
            border: 2px solid #fff;
        }

        .hc-avatar + .hc-avatar {
            margin-left: -10px;
        }

        /* Card layout inspired by Menilo template */
        .hc-kanban-cardwrap {
            border-radius: .75rem;
            overflow: hidden;
        }

        .hc-badge-subtle {
            font-weight: 600;
            font-size: .72rem;
            border-radius: .5rem;
            padding: .45rem .6rem;
            display: inline-flex;
            align-items: center;
            gap: .35rem;
        }

        .hc-badge-success-subtle {
            background: rgba(40, 167, 69, .12);
            color: #198754;
        }

        .hc-badge-primary-subtle {
            background: rgba(13, 110, 253, .12);
            color: #0d6efd;
        }

        .hc-badge-warning-subtle {
            background: rgba(255, 193, 7, .16);
            color: #b08900;
        }

        .hc-badge-danger-subtle {
            background: rgba(220, 53, 69, .14);
            color: #dc3545;
        }

        .hc-badge-secondary-subtle {
            background: rgba(108, 117, 125, .14);
            color: #6c757d;
        }

        .hc-badge-info-subtle {
            background: rgba(13, 202, 240, .16);
            color: #0aa2c0;
        }

        .hc-kanban-pill-start-date{
            border: 1px dashed rgb(21, 255, 0);
            border-radius: 4px;
            padding: .25rem;
            @* color: rgba(0,0,0,.6); *@
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            font-size: 10px;
        }

        .hc-kanban-pill-due-date{
            border: 1px dashed rgba(255, 0, 0, 1);
            border-radius: 4px;
            padding: .25rem;
            @* color: rgba(0,0,0,.6); *@
            display: inline-flex;
            align-items: center;
            gap: .35rem;
            font-size: 10px;
        }



        .hc-kanban-actions .btn {
            border: 0;
            padding: 0;
        }

        /* Hide dropdown caret, keep only 3-dots icon */
        .hc-kanban-actions .dropdown-toggle::after {
            display: none !important;
        }

        .hc-kanban-footer-split {
            display: flex;
            align-items: center;
            gap: .75rem;
        }

        .hc-kanban-footer-divider {
            width: 1px;
            height: 26px;
            background: rgba(0,0,0,.12);
        }

        .hc-kanban-footer-meta {
            display: flex;
            align-items: center;
            gap: .75rem;
            color: rgba(0,0,0,.55);
            font-size: .85rem;
        }

        /* Menilo-like typography + borders */
        .fs-13 {
            font-size: 0.8125rem !important;
        }

        .hc-kanban-cardwrap h6,
        .hc-kanban-cardwrap .h6 {
            font-size: 0.875rem;
        }

        .hc-kanban-cardwrap {
            --pe-card-border-width: 1px;
            --pe-card-border-color: #e9e9e9;
        }

        .hc-kanban-cardwrap .card-body {
            padding: .75rem;
            border-bottom: var(--pe-card-border-width) solid var(--pe-card-border-color);
        }
        .hc-kanban-cardwrap .card-footer {
            padding: .75rem !important;
        }
    </style>

    <Card>
        <CardBody>
            <Div class="hc-kanban-board">
                @if (IsKanbanUpdating)
                {
                    <Div class="hc-kanban-loading">
                        <RadarSpinner />
                    </Div>
                }
                <DropContainer TItem="KanbanItem"
                               @key="KanbanRenderKey"
                               Items="@KanbanItems"
                               ItemsFilter="@((item, zone) => item.Status.ToString() == zone)"
                               ItemDropped="@OnKanbanItemDropped"
                               Flex="Flex.Wrap.Grow.Is1">
                    <ChildContent>
                        <Div class="d-flex gap-3">
                            <Div class="hc-kanban-column">
                                <Div class="d-flex justify-content-between align-items-center mb-2">
                                    <Heading Size="HeadingSize.Is6" class="mb-0">@GetStatusText(ProjectTaskStatus.TODO)</Heading>
                                    <Badge Color="Color.Light" class="hc-kanban-muted">@GetKanbanTotalCount(ProjectTaskStatus.TODO)</Badge>
                                </Div>
                                <DropZone TItem="KanbanItem"
                                          Name="@ProjectTaskStatus.TODO.ToString()"
                                          Class="hc-kanban-zone">
                                </DropZone>
                                <Div class="text-center mt-2">
                                    <Button Color="Color.Light" Size="Size.Small" 
                                            Clicked="@(() => LoadMoreKanbanItemsAsync(ProjectTaskStatus.TODO))"
                                            Visible="@HasMoreKanbanItems(ProjectTaskStatus.TODO)">
                                        @L["LoadMore"]
                                    </Button>
                                </Div>
                            </Div>

                            <Div class="hc-kanban-column">
                                <Div class="d-flex justify-content-between align-items-center mb-2">
                                    <Heading Size="HeadingSize.Is6" class="mb-0">@GetStatusText(ProjectTaskStatus.IN_PROGRESS)</Heading>
                                    <Badge Color="Color.Light" class="hc-kanban-muted">@GetKanbanTotalCount(ProjectTaskStatus.IN_PROGRESS)</Badge>
                                </Div>
                                <DropZone TItem="KanbanItem"
                                          Name="@ProjectTaskStatus.IN_PROGRESS.ToString()"
                                          Class="hc-kanban-zone">
                                </DropZone>
                                <Div class="text-center mt-2">
                                    <Button Color="Color.Light" Size="Size.Small" 
                                            Clicked="@(() => LoadMoreKanbanItemsAsync(ProjectTaskStatus.IN_PROGRESS))"
                                            Visible="@HasMoreKanbanItems(ProjectTaskStatus.IN_PROGRESS)">
                                        @L["LoadMore"]
                                    </Button>
                                </Div>
                            </Div>

                            <Div class="hc-kanban-column">
                                <Div class="d-flex justify-content-between align-items-center mb-2">
                                    <Heading Size="HeadingSize.Is6" class="mb-0">@GetStatusText(ProjectTaskStatus.WAITING)</Heading>
                                    <Badge Color="Color.Light" class="hc-kanban-muted">@GetKanbanTotalCount(ProjectTaskStatus.WAITING)</Badge>
                                </Div>
                                <DropZone TItem="KanbanItem"
                                          Name="@ProjectTaskStatus.WAITING.ToString()"
                                          Class="hc-kanban-zone">
                                </DropZone>
                                <Div class="text-center mt-2">
                                    <Button Color="Color.Light" Size="Size.Small" 
                                            Clicked="@(() => LoadMoreKanbanItemsAsync(ProjectTaskStatus.WAITING))"
                                            Visible="@HasMoreKanbanItems(ProjectTaskStatus.WAITING)">
                                        @L["LoadMore"]
                                    </Button>
                                </Div>
                            </Div>

                            <Div class="hc-kanban-column">
                                <Div class="d-flex justify-content-between align-items-center mb-2">
                                    <Heading Size="HeadingSize.Is6" class="mb-0">@GetStatusText(ProjectTaskStatus.DONE)</Heading>
                                    <Badge Color="Color.Light" class="hc-kanban-muted">@GetKanbanTotalCount(ProjectTaskStatus.DONE)</Badge>
                                </Div>
                                <DropZone TItem="KanbanItem"
                                          Name="@ProjectTaskStatus.DONE.ToString()"
                                          Class="hc-kanban-zone">
                                </DropZone>
                                <Div class="text-center mt-2">
                                    <Button Color="Color.Light" Size="Size.Small" 
                                            Clicked="@(() => LoadMoreKanbanItemsAsync(ProjectTaskStatus.DONE))"
                                            Visible="@HasMoreKanbanItems(ProjectTaskStatus.DONE)">
                                        @L["LoadMore"]
                                    </Button>
                                </Div>
                            </Div>

                            <Div class="hc-kanban-column">
                                <Div class="d-flex justify-content-between align-items-center mb-2">
                                    <Heading Size="HeadingSize.Is6" class="mb-0">@GetStatusText(ProjectTaskStatus.CANCELLED)</Heading>
                                    <Badge Color="Color.Light" class="hc-kanban-muted">@GetKanbanTotalCount(ProjectTaskStatus.CANCELLED)</Badge>
                                </Div>
                                <DropZone TItem="KanbanItem"
                                          Name="@ProjectTaskStatus.CANCELLED.ToString()"
                                          Class="hc-kanban-zone">
                                </DropZone>
                                <Div class="text-center mt-2">
                                    <Button Color="Color.Light" Size="Size.Small" 
                                            Clicked="@(() => LoadMoreKanbanItemsAsync(ProjectTaskStatus.CANCELLED))"
                                            Visible="@HasMoreKanbanItems(ProjectTaskStatus.CANCELLED)">
                                        @L["LoadMore"]
                                    </Button>
                                </Div>
                            </Div>
                        </Div>
                    </ChildContent>

                    <ItemTemplate>
                        <div draggable="true" class="hc-kanban-card mb-2">
                            <div class="card border hc-kanban-cardwrap">
                                <div class="card-body">
                                    <div class="d-flex align-items-start justify-content-between">
                                        <div class="d-flex flex-wrap gap-2">
                                            @* Project badge on top (like Menilo) *@
                                            @if (!string.IsNullOrWhiteSpace(context.ProjectName))
                                            {
                                                <span class="hc-badge-subtle hc-badge-primary-subtle">@context.ProjectName</span>
                                            }
                                        </div>

                                        <div class="hc-kanban-actions">
                                            <Dropdown>
                                                <DropdownToggle Color="Color.Light" Class="btn border-0 p-0" Style="background: transparent;">
                                                    <i aria-hidden="true" class="fa fa-ellipsis-h"></i>
                                                </DropdownToggle>
                                                <DropdownMenu RightAligned="true">
                                                    <DropdownItem Clicked="@EventCallback.Factory.Create(this, async () => await OpenEditProjectTaskModalAsync(context.ProjectTaskWithNavigationProperties))">
                                                        @L["Edit"]
                                                    </DropdownItem>
                                                    <DropdownItem Clicked="@EventCallback.Factory.Create(this, async () => await DeleteProjectTaskAsync(context.ProjectTaskWithNavigationProperties))">
                                                        @L["Delete"]
                                                    </DropdownItem>
                                                </DropdownMenu>
                                            </Dropdown>
                                        </div>
                                    </div>

                                    <div class="py-2">
                                        @if (!string.IsNullOrWhiteSpace(context.ParentTaskCode))
                                        {
                                            <div class="fs-13 text-success mb-1">
                                                @L["ParentTaskTitle"]: #@context.ParentTaskCode - @context.ParentTaskTitle
                                            </div>
                                        }
                                        <h6 class="mb-1 d-flex align-items-center gap-2">
                                            <span>@context.Title</span>
                                            @if (context.ChildTaskCount > 0)
                                            {
                                                <span class="text-muted fs-13">
                                                    <i aria-hidden="true" class="fa fa-list me-1"></i>@context.ChildTaskCount
                                                </span>
                                            }
                                        </h6>
                                       
                                        @if (!string.IsNullOrWhiteSpace(context.Description))
                                        {
                                            <p class="mb-0 fs-13 text-muted">@context.Description</p>
                                        }
                                        else
                                        {
                                            <p class="mb-0 fs-13 text-muted">@context.Code</p>
                                        }
                                    </div>

                                    @* Other badges moved below details *@
                                    <div class="d-flex flex-wrap gap-2">
                                        <span class="hc-badge-subtle hc-badge-@(GetPriorityBadgeColor(context.Priority) == Color.Danger ? "danger" : GetPriorityBadgeColor(context.Priority) == Color.Warning ? "warning" : GetPriorityBadgeColor(context.Priority) == Color.Info ? "info" : "secondary")-subtle">
                                            @GetPriorityText(context.Priority)
                                        </span>
                                        <span class="hc-badge-subtle hc-badge-@(GetPercentBadgeColor(context.ProgressPercent) == Color.Success ? "success" : GetPercentBadgeColor(context.ProgressPercent) == Color.Primary ? "primary" : GetPercentBadgeColor(context.ProgressPercent) == Color.Warning ? "warning" : "danger")-subtle">
                                            @context.ProgressPercent%
                                        </span>
                                    </div>

                                    <div class="d-flex flex-wrap gap-1 mt-1">
                                        <span class="hc-kanban-pill-start-date">
                                            <i aria-hidden="true" class="fa fa-calendar-day"></i>
                                            @context.ProjectTask.StartDate.ToString("dd/MM/yyyy HH:mm")
                                        </span>
                                        <span class="hc-kanban-pill-due-date">
                                            <i aria-hidden="true" class="fa fa-calendar-check"></i>
                                            @context.ProjectTask.DueDate.ToString("dd/MM/yyyy HH:mm")
                                        </span>
                                    </div>
                                </div>

                                <div class="card-footer d-flex align-items-center justify-content-between">
                                    <div class="hc-avatar-stack">
                                        @foreach (var user in context.Assignees)
                                        {
                                            <Div class="hc-avatar" title="@GetUserDisplayName(user)">
                                                @GetUserInitial(user)
                                            </Div>
                                        }
                                    </div>
                                    <div class="hc-kanban-footer-split">
                                        <div class="hc-kanban-footer-divider"></div>
                                        <div class="hc-kanban-footer-meta">
                                            @if (context.ChildTaskCount > 0)
                                            {
                                                <span><i aria-hidden="true" class="fa fa-list me-1"></i>@context.ChildTaskCount</span>
                                            }
                                            @if (context.DocumentsCount > 0)
                                            {
                                                <span style="color:#0d6efd; cursor: pointer;" @onclick="@(() => OpenEditProjectTaskModalToDocumentsTabAsync(context.ProjectTaskWithNavigationProperties))" title="@L["ViewDocuments"]">
                                                    <i aria-hidden="true" class="fa fa-paperclip me-1"></i>@context.DocumentsCount
                                                </span>
                                            }
                                            else
                                            {
                                                <span><i aria-hidden="true" class="fa fa-paperclip me-1"></i>@context.DocumentsCount</span>
                                            }
                                            <span><i aria-hidden="true" class="fa fa-hashtag me-1"></i>@context.Code</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </ItemTemplate>
                </DropContainer>
            </Div>
        </CardBody>
    </Card>
}
else
{
@* ************************* SEARCH ************************* *@
<Card>
    <CardBody>
@*//<suite-custom-code-block-1>*@
@*//</suite-custom-code-block-1>*@
        <Row>
            <div class="col col-md-8 col-lg-10">
                <div class="mb-3">
                    <Form id="ProjectTaskSearchForm">
                        <Addons>
                            <Addon AddonType="AddonType.Body">
                                <TextEdit @bind-Text="@Filter.FilterText"
                                        Autofocus="true"
                                        Placeholder="@L["Search"]">
                                </TextEdit>
                            </Addon>
                            <Addon AddonType="AddonType.End">
                                <SubmitButton Form="ProjectTaskSearchForm" Clicked="GetProjectTasksAsync">
                                    <Icon Name="IconName.Search" Class="me-1"></Icon>@L["Search"]
                                </SubmitButton>
                            </Addon>
                        </Addons>
                    </Form>
                </div>
            </div>
                   <div class="col-md-4 col-lg-2">
            <div class="mb-3">
               <Button Color="Color.Primary" Outline Style="width:100%" id="AdvancedFilterSectionToggler"
                         Clicked="@(() => ShowAdvancedFilters = !ShowAdvancedFilters)">@L["Filters"]
                         <i aria-hidden="true" class="fa ms-1 @(!ShowAdvancedFilters ? "fa-angle-down" : "fa-angle-up")"></i>
               </Button>
            </div>
       </div>
        <div style="display: @(!ShowAdvancedFilters ? "none" : "block")"  class="mt-3">
            <Row>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["ParentTaskId"]</FieldLabel>
                        <TextEdit Text="@Filter.ParentTaskId" TextChanged="@OnParentTaskIdChangedAsync" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["Code"]</FieldLabel>
                        <TextEdit Text="@Filter.Code" TextChanged="@OnCodeChangedAsync" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["Title"]</FieldLabel>
                        <TextEdit Text="@Filter.Title" TextChanged="@OnTitleChangedAsync" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["Description"]</FieldLabel>
                        <TextEdit Text="@Filter.Description" TextChanged="@OnDescriptionChangedAsync" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["MinStartDate"]</FieldLabel>
                        <DatePicker TValue="DateTime?"
            InputMode="DateInputMode.Date"
            Date="@Filter.StartDateMin"
            DateChanged="@OnStartDateMinChangedAsync"
            Placeholder="@string.Empty" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["MaxStartDate"]</FieldLabel>
                        <DatePicker TValue="DateTime?"
            InputMode="DateInputMode.Date"
            Date="@Filter.StartDateMax"
            DateChanged="@OnStartDateMaxChangedAsync"
            Placeholder="@string.Empty" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["MinDueDate"]</FieldLabel>
                        <DatePicker TValue="DateTime?"
            InputMode="DateInputMode.Date"
            Date="@Filter.DueDateMin"
            DateChanged="@OnDueDateMinChangedAsync"
            Placeholder="@string.Empty" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["MaxDueDate"]</FieldLabel>
                        <DatePicker TValue="DateTime?"
            InputMode="DateInputMode.Date"
            Date="@Filter.DueDateMax"
            DateChanged="@OnDueDateMaxChangedAsync"
            Placeholder="@string.Empty" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["Priority"]</FieldLabel>
                        <TextEdit Text="@Filter.Priority" TextChanged="@OnPriorityChangedAsync" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["Status"]</FieldLabel>
                        <TextEdit Text="@Filter.Status" TextChanged="@OnStatusChangedAsync" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["MinProgressPercent"]</FieldLabel>
                        <NumericEdit TValue="int?" 
             Value="@Filter.ProgressPercentMin"
             ValueChanged="@OnProgressPercentMinChangedAsync" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["MaxProgressPercent"]</FieldLabel>
                        <NumericEdit TValue="int?" 
             Value="@Filter.ProgressPercentMax"
             ValueChanged="@OnProgressPercentMaxChangedAsync" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["Project"]</FieldLabel>
                        <Select TValue="Guid?"
		SelectedValue="@Filter.ProjectId"
		SelectedValueChanged="@OnProjectIdChangedAsync">
<SelectItem></SelectItem>
@foreach(var item in ProjectsCollection)
{
	<SelectItem TValue="Guid" Value="@item.Id">
		@item.DisplayName
	</SelectItem>
}
</Select>                       
                    </Field>
                </Column>
            </Row>
@*//<suite-custom-code-block-2>*@
@*//</suite-custom-code-block-2>*@
        </div>
        </Row>
@*//<suite-custom-code-block-3>*@
@*//</suite-custom-code-block-3>*@
    </CardBody>
</Card>
@* ************************* DATA GRID ************************* *@
<Card>
    <CardBody>        
        <Div  Visibility="@(SelectedProjectTasks.Any() ? Visibility.Visible : Visibility.Invisible)"
              class="d-flex justify-content-between align-items-center mb-2">
              <p class="lead mb-0">
                @if (AllProjectTasksSelected)
                {
                    @L["AllItemsAreSelected", TotalCount]
                }
                else
                {
                    @if (SelectedProjectTasks.Count > 1)
                    {
                        @L["NumberOfItemsOnThisPageAreSelected", SelectedProjectTasks.Count]
                    }
                    else
                    {
                        @L["OneItemOnThisPageIsSelected"]
                    }
                }
              </p>
            <div>
                @if ((SelectedProjectTasks.Count == PageSize || SelectedProjectTasks.Count == ProjectTaskList.Count) && TotalCount > SelectedProjectTasks.Count)
                {
                    if (!AllProjectTasksSelected)
                    {
                        <Button Clicked="SelectAllItems" Class="mx-1 btn-outline-secondary">@L["SelectAllItems", TotalCount]</Button>
                    }
                    else
                    {
                        <Button Clicked="ClearSelection" Class="mx-1 btn-outline-secondary">@L["ClearSelection"]</Button>
                    }
                }
                <Button Color="Color.Danger" Class="mx-1" Size="Size.Medium" Clicked="DeleteSelectedProjectTasksAsync">
                    <Icon Name="@IconName.Delete" /> @L["Delete"]
                </Button>
            </div>
        </Div>
        <hr Visibility="@(SelectedProjectTasks.Any() ? Visibility.Visible : Visibility.Invisible)"
            class="my-1 mx-0" />
        <DataGrid TItem="ProjectTaskWithNavigationPropertiesDto"
                  @ref="DataGridRef"
                  Data="ProjectTaskList"
                  SelectionMode="DataGridSelectionMode.Multiple"
                  SelectedRows="SelectedProjectTasks"
                  RowSelectable="RowSelectableHandler"
                  SelectedRowsChanged="SelectedProjectTaskRowsChanged"
                  ReadData="OnDataGridReadAsync"
                  TotalItems="TotalCount"
                  ShowPager="true"
                  Responsive="true"
                  PageSize="PageSize"
                  Class="datagrid-detail">
            <LoadingTemplate>
                <Row Class="w-100 align-items-center" Style="height: 150px;">
                    <Column>
                       <RadarSpinner />
                    </Column>
                </Row>
            </LoadingTemplate>
            <EmptyTemplate>
                <Row Class="w-100 align-items-center" Style="height: 150px;">
                    <Column>
                        <Heading Size="HeadingSize.Is4" TextAlignment="TextAlignment.Center">@L["NoDataAvailable"]</Heading>
                    </Column>
                </Row>
            </EmptyTemplate>   
            <DataGridColumns>
                @if (CanDeleteProjectTask && ProjectTaskList.Any())
                {
                    <DataGridMultiSelectColumn TItem="ProjectTaskWithNavigationPropertiesDto" DisplayOrder="-1" Width="30px"></DataGridMultiSelectColumn>
                }
                <DataGridEntityActionsColumn TItem="ProjectTaskWithNavigationPropertiesDto" @ref="@EntityActionsColumn">
                    <DisplayTemplate>
                        <EntityActions TItem="ProjectTaskWithNavigationPropertiesDto" 
                        EntityActionsColumn="@EntityActionsColumn">
                            <EntityAction TItem="ProjectTaskWithNavigationPropertiesDto"
                                          Visible="@CanEditProjectTask"
                                          Clicked="async () => await OpenEditProjectTaskModalAsync(context)"
                                          Icon="fas fa-pencil"
                                          Text="@L["Edit"]"></EntityAction>
                            <EntityAction TItem="ProjectTaskWithNavigationPropertiesDto"
                                          Visible="@CanDeleteProjectTask"
                                          Clicked="() => DeleteProjectTaskAsync(context)"
                                          Icon="fas fa-trash"
                                          ConfirmationMessage="@(()=> L["DeleteConfirmationMessage"])"
                                          Text="@L["Delete"]"></EntityAction>
@*//<suite-custom-code-block-4>*@
@*//</suite-custom-code-block-4>*@
                        </EntityActions>
                    </DisplayTemplate>
                </DataGridEntityActionsColumn>
              <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto"
                      Field="ProjectTask.ParentTaskId"
                      Caption="@L["ParentTaskId"]">
              </DataGridColumn>
              <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto"
                      Field="ProjectTask.Code"
                      Caption="@L["Code"]">
              </DataGridColumn>
              <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto"
                      Field="ProjectTask.Title"
                      Caption="@L["Title"]">
                  <DisplayTemplate>
                      @if (!string.IsNullOrWhiteSpace(context.ProjectTask.ParentTaskId))
                      {
                          <div class="text-muted">
                              @L["ParentTaskTitle"]: #@context.ProjectTask.ParentTaskId - @context.ParentTaskTitle
                          </div>
                      }
                      <div class="d-flex align-items-center gap-2">
                          <span>@context.ProjectTask.Title</span>
                          @if (context.ChildTaskCount > 0)
                          {
                              <span class="text-muted">
                                  <i aria-hidden="true" class="fa fa-list me-1"></i>@context.ChildTaskCount
                              </span>
                          }
                      </div>
                  </DisplayTemplate>
              </DataGridColumn>
              <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto"
                      Field="ProjectTask.Description"
                      Caption="@L["Description"]">
              </DataGridColumn>
              <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto"
                      Field="ProjectTask.StartDate"
                      Caption="@L["StartDate"]">
                  <DisplayTemplate>
                        @context.ProjectTask.StartDate.ToString("dd/MM/yyyy HH:mm")
                  </DisplayTemplate>
              </DataGridColumn>
              <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto"
                      Field="ProjectTask.DueDate"
                      Caption="@L["DueDate"]">
                  <DisplayTemplate>
                        @context.ProjectTask.DueDate.ToString("dd/MM/yyyy HH:mm")
                  </DisplayTemplate>
              </DataGridColumn>
              <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto"
                      Field="ProjectTask.Priority"
                      Caption="@L["Priority"]">
                  <DisplayTemplate>
                      @{
                          var priority = ParsePriority(context.ProjectTask.Priority);
                      }
                      <Badge Color="@GetPriorityBadgeColor(priority)">
                          @GetPriorityText(priority)
                      </Badge>
                  </DisplayTemplate>
              </DataGridColumn>
              <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto"
                      Field="ProjectTask.Status"
                      Caption="@L["Status"]">
                  <DisplayTemplate>
                      @{
                          var status = ParseStatus(context.ProjectTask.Status);
                      }
                      <Badge Color="@GetStatusBadgeColor(status)">
                          @GetStatusText(status)
                      </Badge>
                  </DisplayTemplate>
              </DataGridColumn>
              <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto"
                      Field="ProjectTask.ProgressPercent"
                      Caption="@L["ProgressPercent"]">
                  <DisplayTemplate>
                      <div class="d-flex align-items-center gap-2">
                          <Progress Value="@context.ProjectTask.ProgressPercent" Max="100" Class="hc-progress" />
                          <span class="text-muted small">@context.ProjectTask.ProgressPercent%</span>
                      </div>
                  </DisplayTemplate>
              </DataGridColumn>
              <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto"
                      Field="Project.Name"
                      Caption="@L["Project"]">
              </DataGridColumn>
            </DataGridColumns>
        </DataGrid>
    </CardBody>
</Card>
}

@* ************************* CREATE MODAL ************************* *@
<Modal @ref="CreateProjectTaskModal" Closing="@CreateProjectTaskModal.CancelClosingModalWhenFocusLost">
    <ModalContent Size="ModalSize.Large" Centered="true">
@*//<suite-custom-code-block-5>*@
@*//</suite-custom-code-block-5>*@
        <Form id="CreateProjectTaskForm">
            <ModalHeader>
                <ModalTitle>@L["NewTask"]</ModalTitle>
                <CloseButton Clicked="CancelCreateWizardAsync" />
            </ModalHeader>
            <ModalBody>
                <Tabs SelectedTab="@SelectedCreateTab" SelectedTabChanged="@OnSelectedCreateTabChanged">
                    <Items>
                        <Tab Name="general">@L["Tab:GeneralInformation"]</Tab>
                        <Tab Name="assignments" Disabled="@(!IsCreateWizardGeneralSaved)">@L["Tab:Assignments"]</Tab>
                        <Tab Name="documents" Disabled="@(!IsCreateWizardGeneralSaved)">@L["Tab:Documents"]</Tab>
                    </Items>
                    <Content>
                        <TabPanel Name="general">
                            @if (!string.IsNullOrWhiteSpace(CreateGeneralValidationErrorKey))
                            {
                                <Alert Color="Color.Danger">
                                    <AlertMessage>@L["NotificationError"]!</AlertMessage>
                                    <AlertDescription>@L[CreateGeneralValidationErrorKey]</AlertDescription>
                                </Alert>
                            }
                            <Row Class="g-3">
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["Project"] *</FieldLabel>
                                        <div class="hc-select2-full" style="@(HasCreateFieldError("Project") ? "border: 1px solid #dc3545; border-radius: 0.25rem; padding: 2px;" : "")">
                                            <Select2 IdSelector="c => c.Id.ToString()"
                                                     TextSelector="c => c.DisplayName"
                                                     FilterFunction="GetProjectCollectionLookupAsync"
                                                     GetElementById="async (items, id, token) => items.Where(x => x.Id.ToString() == id).FirstOrDefault()!"
                                                     Datasource="ProjectsCollection"
                                                     Value="@SelectedNewProjectTaskProject"
                                                     OnValueChanged="@(() => { OnNewProjectTaskProjectChanged(); CreateFieldErrors.Remove("Project"); })"
                                                     Cache="__MemoryCache"
                                                     Multiselect="false" />
                                        </div>
                                        @if (HasCreateFieldError("Project"))
                                        {
                                            <div class="invalid-feedback d-block">@GetCreateFieldError("Project")</div>
                                        }
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["ParentTaskId"]</FieldLabel>
                                        <div class="hc-select2-full">
                                            <Select2 IdSelector="c => c.Id"
                                                     TextSelector="c => c.DisplayName"
                                                     FilterFunction="GetParentTaskCollectionLookupAsync"
                                                     GetElementById="async (items, id, token) => items.Where(x => x.Id == id).FirstOrDefault()!"
                                                     Datasource="ParentTasksCollection"
                                                     Value="@SelectedNewProjectTaskParentTask"
                                                     OnValueChanged="OnNewProjectTaskParentChanged"
                                                     Cache="__MemoryCache"
                                                     Multiselect="false" />
                                        </div>
                                    </Field>
                                </Column>
                            </Row>

                            @* Manual validation is used for Create wizard (see ValidateCreateGeneralInformation). *@
                            @if (!string.IsNullOrWhiteSpace(CreateGeneralValidationErrorKey))
                            {
                                <Alert Color="Color.Danger">
                                    <AlertMessage>@L["NotificationError"]!</AlertMessage>
                                    <AlertDescription>@L[CreateGeneralValidationErrorKey]</AlertDescription>
                                </Alert>
                            }
                            <Row Class="g-3 mt-1">
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["Code"] *</FieldLabel>
                                        <TextEdit Text="@NewProjectTask.Code"
                                                  TextChanged="@((string value) => { NewProjectTask.Code = value; CreateFieldErrors.Remove("Code"); })"
                                                  MaxLength="ProjectTaskConsts.CodeMaxLength"
                                                  Autofocus="true"
                                                  ReadOnly="true"
                                                  Disabled="@IsCreateWizardGeneralSaved"
                                                  Style="@(HasCreateFieldError("Code") ? "border-color: #dc3545;" : "")" />
                                        @if (HasCreateFieldError("Code"))
                                        {
                                            <div class="invalid-feedback d-block">@GetCreateFieldError("Code")</div>
                                        }
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["Title"] *</FieldLabel>
                                        <TextEdit Text="@NewProjectTask.Title"
                                                  TextChanged="@((string value) => { NewProjectTask.Title = value; CreateFieldErrors.Remove("Title"); })"
                                                  MaxLength="ProjectTaskConsts.TitleMaxLength"
                                                  Disabled="@IsCreateWizardGeneralSaved"
                                                  Style="@(HasCreateFieldError("Title") ? "border-color: #dc3545;" : "")" />
                                        @if (HasCreateFieldError("Title"))
                                        {
                                            <div class="invalid-feedback d-block">@GetCreateFieldError("Title")</div>
                                        }
                                    </Field>
                                </Column>

                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["Priority"] *</FieldLabel>
                                        <div style="@(HasCreateFieldError("Priority") ? "border: 1px solid #dc3545; border-radius: 0.25rem; padding: 2px;" : "")">
                                            <Select TValue="ProjectTaskPriority"
                                                    SelectedValue="@NewProjectTaskPriority"
                                                    SelectedValueChanged="@((ProjectTaskPriority value) => { OnNewProjectTaskPriorityChanged(value); CreateFieldErrors.Remove("Priority"); })"
                                                    Disabled="@IsCreateWizardGeneralSaved">
                                                <ChildContent>
                                                    @foreach (var priority in Enum.GetValues<ProjectTaskPriority>())
                                                    {
                                                        <SelectItem TValue="ProjectTaskPriority" Value="@priority">
                                                            @L[$"Enum:ProjectTaskPriority.{priority}"]
                                                        </SelectItem>
                                                    }
                                                </ChildContent>
                                            </Select>
                                        </div>
                                        @if (HasCreateFieldError("Priority"))
                                        {
                                            <div class="invalid-feedback d-block">@GetCreateFieldError("Priority")</div>
                                        }
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["Status"] *</FieldLabel>
                                        <div style="@(HasCreateFieldError("Status") ? "border: 1px solid #dc3545; border-radius: 0.25rem; padding: 2px;" : "")">
                                            <Select TValue="ProjectTaskStatus"
                                                    SelectedValue="@NewProjectTaskStatus"
                                                    SelectedValueChanged="@((ProjectTaskStatus value) => { OnNewProjectTaskStatusChanged(value); CreateFieldErrors.Remove("Status"); })"
                                                    Disabled="@IsCreateWizardGeneralSaved">
                                                <ChildContent>
                                                    @foreach (var status in Enum.GetValues<ProjectTaskStatus>())
                                                    {
                                                        <SelectItem TValue="ProjectTaskStatus" Value="@status">
                                                            @L[$"Enum:ProjectTaskStatus.{status}"]
                                                        </SelectItem>
                                                    }
                                                </ChildContent>
                                            </Select>
                                        </div>
                                        @if (HasCreateFieldError("Status"))
                                        {
                                            <div class="invalid-feedback d-block">@GetCreateFieldError("Status")</div>
                                        }
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["ProgressPercent"]</FieldLabel>
                                        <NumericPicker TValue="int"
                                                       Value="@NewProjectTask.ProgressPercent"
                                                       ValueChanged="@((int value) => { NewProjectTask.ProgressPercent = value; CreateFieldErrors.Remove("ProgressPercent"); })"
                                                       Min="ProjectTaskConsts.ProgressPercentMinLength"
                                                       Max="ProjectTaskConsts.ProgressPercentMaxLength"
                                                       Decimals="0"
                                                       Disabled="@IsCreateWizardGeneralSaved"
                                                       Style="@(HasCreateFieldError("ProgressPercent") ? "border-color: #dc3545;" : "")" />
                                        @if (HasCreateFieldError("ProgressPercent"))
                                        {
                                            <div class="invalid-feedback d-block">@GetCreateFieldError("ProgressPercent")</div>
                                        }
                                    </Field>
                                </Column>
                            </Row>

                            @* DatePicker is outside Validations to avoid Blazorise validator inference errors. *@
                            <Row Class="g-3 mt-1">
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["StartDate"]</FieldLabel>
                                        <Addons>
                                            <Addon AddonType="AddonType.Body">
                                                <DatePicker TValue="DateTime"
                                                            InputMode="DateInputMode.DateTime"
                                                            Date="@NewProjectTask.StartDate"
                                                            DateChanged="@(v => NewProjectTask.StartDate = v)"
                                                            Placeholder="@string.Empty"
                                                            DisplayFormat="dd/MM/yyyy HH:mm"
                                                            InputFormat="dd/MM/yyyy HH:mm"
                                                            Disabled="@IsCreateWizardGeneralSaved"
                                                            @ref="@NewProjectTaskStartDateDatePicker" />
                                            </Addon>
                                            <Addon AddonType="AddonType.End">
                                                <Button Color="Color.Light" Disabled="@IsCreateWizardGeneralSaved" Clicked="@(() => NewProjectTaskStartDateDatePicker?.ToggleAsync())">
                                                    <Icon Name="IconName.CalendarDay" />
                                                </Button>
                                            </Addon>
                                        </Addons>
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["DueDate"]</FieldLabel>
                                        <Addons>
                                            <Addon AddonType="AddonType.Body">
                                                <DatePicker TValue="DateTime"
                                                            InputMode="DateInputMode.DateTime"
                                                            Date="@NewProjectTask.DueDate"
                                                            DateChanged="@(v => NewProjectTask.DueDate = v)"
                                                            Placeholder="@string.Empty"
                                                            DisplayFormat="dd/MM/yyyy HH:mm"
                                                            InputFormat="dd/MM/yyyy HH:mm"
                                                            Disabled="@IsCreateWizardGeneralSaved"
                                                            @ref="@NewProjectTaskDueDateDatePicker" />
                                            </Addon>
                                            <Addon AddonType="AddonType.End">
                                                <Button Color="Color.Light" Disabled="@IsCreateWizardGeneralSaved" Clicked="@(() => NewProjectTaskDueDateDatePicker?.ToggleAsync())">
                                                    <Icon Name="IconName.CalendarDay" />
                                                </Button>
                                            </Addon>
                                        </Addons>
                                    </Field>
                                </Column>
                            </Row>

                            <Row Class="g-3 mt-1">
                                <Column ColumnSize="ColumnSize.Is12">
                                    <Field>
                                        <FieldLabel>@L["Description"]</FieldLabel>
                                        <MemoEdit @bind-Text="@NewProjectTask.Description" Disabled="@IsCreateWizardGeneralSaved" />
                                    </Field>
                                </Column>
                            </Row>
                        </TabPanel>

                        <TabPanel Name="assignments">
                            @if (!IsCreateWizardGeneralSaved)
                            {
                                <Alert Color="Color.Warning">@L["CreateWizard:SaveGeneralFirst"]</Alert>
                            }
                            else
                            {
                                <Row Class="g-3 align-items-center">
                                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                        <Field>
                                            <FieldLabel>@L["Assignee"] *</FieldLabel>
                                            <div class="hc-select2-full">
                                                <Select2 IdSelector="c => c.Id.ToString()"
                                                        TextSelector="c => c.DisplayName"
                                                        FilterFunction="GetAssignmentIdentityUserLookupAsync"
                                                        GetElementById="async (items, id, token) => items.Where(x => x.Id.ToString() == id).FirstOrDefault()!"
                                                        Datasource="AssignmentIdentityUsersCollection"
                                                        Value="@CreateAssignmentsUsersToAdd"
                                                        OnValueChanged="OnCreateAssignmentUserChanged"
                                                        Cache="__MemoryCache"
                                                        Multiselect="false" />
                                            </div>
                                        </Field>
                                    </Column>
                                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is3.OnDesktop">
                                        <Field>
                                            <FieldLabel>@L["AssignmentRole"] *</FieldLabel>
                                            <Select TValue="ProjectTaskAssignmentRole" @bind-SelectedValue="CreateAssignmentRole" Class="w-100">
                                                @foreach (var role in Enum.GetValues<ProjectTaskAssignmentRole>())
                                                {
                                                    <SelectItem TValue="ProjectTaskAssignmentRole" Value="@role">
                                                        @L[$"Enum:ProjectTaskAssignmentRole.{role}"]
                                                    </SelectItem>
                                                }
                                            </Select>
                                        </Field>
                                    </Column>
                                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is3.OnDesktop">
                                        <Button Color="Color.Primary" Class="w-100" Clicked="AddAssignmentAsync">
                                            <Icon Name="IconName.Add" Class="me-1" /> @L["Add"]
                                        </Button>
                                    </Column>
                                </Row>
                                <Row Class="g-3 mt-1">
                                    <Column ColumnSize="ColumnSize.Is12">
                                        <Field>
                                            <FieldLabel>@L["Note"]</FieldLabel>
                                            <TextEdit @bind-Text="CreateAssignmentNote" />
                                        </Field>
                                    </Column>
                                </Row>

                                <DataGrid TItem="ProjectTaskAssignmentWithNavigationPropertiesDto"
                                          Data="CreateAssignmentsList"
                                          Responsive="true"
                                          ShowPager="false">
                                    <EmptyTemplate>
                                        <Row Class="w-100 align-items-center" Style="height: 120px;">
                                            <Column>
                                                <Heading Size="HeadingSize.Is6" TextAlignment="TextAlignment.Center">@L["CreateWizard:NoAssignees"]</Heading>
                                            </Column>
                                        </Row>
                                    </EmptyTemplate>
                                    <DataGridColumns>
                                        <DataGridColumn TItem="ProjectTaskAssignmentWithNavigationPropertiesDto" Field="User.UserName" Caption="@L["UserName"]" />
                                        <DataGridColumn TItem="ProjectTaskAssignmentWithNavigationPropertiesDto" Field="ProjectTaskAssignment.AssignmentRole" Caption="@L["AssignmentRole"]">
                                            <DisplayTemplate>
                                                @if (Enum.TryParse<ProjectTaskAssignmentRole>(context.ProjectTaskAssignment.AssignmentRole, ignoreCase: true, out var role))
                                                {
                                                    @L[$"Enum:ProjectTaskAssignmentRole.{role}"]
                                                }
                                                else
                                                {
                                                    @context.ProjectTaskAssignment.AssignmentRole
                                                }
                                            </DisplayTemplate>
                                        </DataGridColumn>
                                        <DataGridColumn TItem="ProjectTaskAssignmentWithNavigationPropertiesDto" Field="ProjectTaskAssignment.AssignedAt" Caption="@L["AssignedAt"]">
                                            <DisplayTemplate>
                                                @context.ProjectTaskAssignment.AssignedAt.ToString("dd/MM/yyyy HH:mm")
                                            </DisplayTemplate>
                                        </DataGridColumn>
                                        <DataGridColumn TItem="ProjectTaskAssignmentWithNavigationPropertiesDto" Field="ProjectTaskAssignment.Note" Caption="@L["Note"]" />
                                        <DataGridColumn TItem="ProjectTaskAssignmentWithNavigationPropertiesDto" Caption="@L["Actions"]">
                                            <DisplayTemplate>
                                                <Button Color="Color.Danger" Outline Size="Size.Small" Clicked="@(() => DeleteAssignmentAsync(context))">
                                                    <Icon Name="IconName.Delete" Class="me-1" /> @L["Delete"]
                                                </Button>
                                            </DisplayTemplate>
                                        </DataGridColumn>
                                    </DataGridColumns>
                                </DataGrid>
                            }
                        </TabPanel>

                        <TabPanel Name="documents">
                            @if (!IsCreateWizardGeneralSaved)
                            {
                                <Alert Color="Color.Warning">@L["CreateWizard:SaveGeneralFirst"]</Alert>
                            }
                            else
                            {
                                <Row Class="g-3 align-items-center">
                                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                        <Field>
                                            <FieldLabel>@L["Document"]</FieldLabel>
                                            <div class="hc-select2-full">
                                                <Select2 IdSelector="c => c.Id.ToString()"
                                                        TextSelector="c => c.DisplayName"
                                                        FilterFunction="GetDocumentLookupAsync"
                                                        GetElementById="async (items, id, token) => items.Where(x => x.Id.ToString() == id).FirstOrDefault()!"
                                                        Datasource="DocumentsLookupCollection"
                                                        Value="@CreateDocumentsToAdd"
                                                        OnValueChanged="OnCreateDocumentChanged"
                                                        Cache="__MemoryCache"
                                                        Multiselect="false" />
                                            </div>
                                        </Field>
                                    </Column>
                                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is3.OnDesktop">
                                        <Field>
                                            <FieldLabel>@L["DocumentPurpose"]</FieldLabel>
                                            <Select TValue="ProjectTaskDocumentPurpose" @bind-SelectedValue="CreateDocumentPurpose" Class="w-100">
                                                @foreach (var purpose in Enum.GetValues<ProjectTaskDocumentPurpose>())
                                                {
                                                    <SelectItem TValue="ProjectTaskDocumentPurpose" Value="@purpose">
                                                        @L[$"Enum:ProjectTaskDocumentPurpose.{purpose}"]
                                                    </SelectItem>
                                                }
                                            </Select>
                                        </Field>
                                    </Column>
                                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is3.OnDesktop">
                                        <Button Color="Color.Primary" Class="w-100" Clicked="AddDocumentAsync">
                                            <Icon Name="IconName.Add" Class="me-1" /> @L["Add"]
                                        </Button>
                                    </Column>
                                </Row>

                                <DataGrid TItem="ProjectTaskDocumentWithNavigationPropertiesDto"
                                          Data="CreateDocumentsList"
                                          Responsive="true"
                                          ShowPager="false">
                                    <EmptyTemplate>
                                        <Row Class="w-100 align-items-center" Style="height: 120px;">
                                            <Column>
                                                <Heading Size="HeadingSize.Is6" TextAlignment="TextAlignment.Center">@L["CreateWizard:NoDocuments"]</Heading>
                                            </Column>
                                        </Row>
                                    </EmptyTemplate>
                                    <DataGridColumns>
                                        <DataGridColumn TItem="ProjectTaskDocumentWithNavigationPropertiesDto" Field="Document.Title" Caption="@L["Title"]" />
                                        <DataGridColumn TItem="ProjectTaskDocumentWithNavigationPropertiesDto" Field="ProjectTaskDocument.DocumentPurpose" Caption="@L["DocumentPurpose"]">
                                            <DisplayTemplate>
                                                @if (context.ProjectTaskDocument != null && !string.IsNullOrWhiteSpace(context.ProjectTaskDocument.DocumentPurpose))
                                                {
                                                    @if (Enum.TryParse<ProjectTaskDocumentPurpose>(context.ProjectTaskDocument.DocumentPurpose, ignoreCase: true, out var purpose))
                                                    {
                                                        @L[$"Enum:ProjectTaskDocumentPurpose.{purpose}"]
                                                    }
                                                    else
                                                    {
                                                        @context.ProjectTaskDocument.DocumentPurpose
                                                    }
                                                }
                                            </DisplayTemplate>
                                        </DataGridColumn>
                                        <DataGridColumn TItem="ProjectTaskDocumentWithNavigationPropertiesDto" Caption="@L["Actions"]">
                                            <DisplayTemplate>
                                                <div class="d-flex gap-2">
                                                    @if (context.Document != null)
                                                    {
                                                        @if (DocumentHasPdfFile(context.Document.Id))
                                                        {
                                                            <Button Color="Color.Info" Size="Size.Small" Clicked="@(() => OpenPdfViewerModalForDocumentAsync(context))" Title="@L["ViewFile"]">
                                                                <Icon Name="IconName.Eye" />
                                                            </Button>
                                                        }
                                                        <Button Color="Color.Primary" Size="Size.Small" Clicked="@(() => DownloadDocumentFileAsync(context))" Title="@L["Download"]">
                                                            <Icon Name="IconName.Download" />
                                                        </Button>
                                                    }
                                                    <Button Color="Color.Danger" Outline Size="Size.Small" Clicked="@(() => DeleteDocumentAsync(context))" Title="@L["Delete"]">
                                                        <Icon Name="IconName.Delete" />
                                                    </Button>
                                                </div>
                                            </DisplayTemplate>
                                        </DataGridColumn>
                                    </DataGridColumns>
                                </DataGrid>
                            }
                        </TabPanel>
                    </Content>
                </Tabs>
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary"
                        Clicked="CancelCreateWizardAsync">
                    @L["Cancel"]
                </Button>
                @if (SelectedCreateTab == "general")
                {
                    <Button Color="Color.Primary" Disabled="@IsCreateWizardGeneralSaved" Clicked="SaveGeneralInformationAsync">
                        <Icon Name="IconName.Save" Class="me-1" /> @L["CreateWizard:SaveAndContinue"]
                    </Button>
                }
                else if (SelectedCreateTab == "assignments")
                {
                    <Button Color="Color.Primary" Clicked="@(() => OnSelectedCreateTabChanged("documents"))">
                        @L["Next"]
                    </Button>
                }
                else if (SelectedCreateTab == "documents")
                {
                    <Button Color="Color.Primary" Clicked="FinishCreateWizardAsync">
                        <Icon Name="IconName.Check" Class="me-1" /> @L["Finish"]
                    </Button>
                }
@*//<suite-custom-code-block-6>*@
@*//</suite-custom-code-block-6>*@
            </ModalFooter>
        </Form>
@*//<suite-custom-code-block-7>*@
@*//</suite-custom-code-block-7>*@
    </ModalContent>
</Modal>
@* ************************* EDIT MODAL ************************* *@
<Modal @ref="EditProjectTaskModal" Closing="@EditProjectTaskModal.CancelClosingModalWhenFocusLost">
    <ModalContent Size="ModalSize.Large" Centered="true">
@*//<suite-custom-code-block-8>*@
@*//</suite-custom-code-block-8>*@
        <Form id="EditProjectTaskForm">
            <ModalHeader>
                <ModalTitle>@L["UpdateTask"]</ModalTitle>
                <CloseButton Clicked="CloseEditProjectTaskModalAsync" />
            </ModalHeader>
            <ModalBody>
                <Tabs SelectedTab="@SelectedEditTab" SelectedTabChanged="@OnSelectedEditTabChanged">
                    <Items>
                        <Tab Name="general">@L["Tab:GeneralInformation"]</Tab>
                        <Tab Name="assignments">@L["Tab:Assignments"]</Tab>
                        <Tab Name="documents">@L["Tab:Documents"]</Tab>
                    </Items>
                    <Content>
                        <TabPanel Name="general">
                            @if (!string.IsNullOrWhiteSpace(EditGeneralValidationErrorKey))
                            {
                                <Alert Color="Color.Danger">
                                    <AlertMessage>@L["NotificationError"]!</AlertMessage>
                                    <AlertDescription>@L[EditGeneralValidationErrorKey]</AlertDescription>
                                </Alert>
                            }

                            <Row Class="g-3">
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["Project"] *</FieldLabel>
                                        <div class="hc-select2-full" style="@(HasEditFieldError("Project") ? "border: 1px solid #dc3545; border-radius: 0.25rem; padding: 2px;" : "")">
                                            <Select2 IdSelector="c => c.Id.ToString()"
                                                     TextSelector="c => c.DisplayName"
                                                     FilterFunction="GetProjectCollectionLookupAsync"
                                                     GetElementById="async (items, id, token) => items.Where(x => x.Id.ToString() == id).FirstOrDefault()!"
                                                     Datasource="ProjectsCollection"
                                                     Value="@SelectedEditProjectTaskProject"
                                                     OnValueChanged="@(() => { OnEditProjectTaskProjectChanged(); EditFieldErrors.Remove("Project"); })"
                                                     Cache="__MemoryCache"
                                                     Multiselect="false" />
                                        </div>
                                        @if (HasEditFieldError("Project"))
                                        {
                                            <div class="invalid-feedback d-block">@GetEditFieldError("Project")</div>
                                        }
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["ParentTaskId"]</FieldLabel>
                                        <div class="hc-select2-full">
                                            <Select2 IdSelector="c => c.Id"
                                                     TextSelector="c => c.DisplayName"
                                                     FilterFunction="GetParentTaskCollectionLookupAsync"
                                                     GetElementById="async (items, id, token) => items.Where(x => x.Id == id).FirstOrDefault()!"
                                                     Datasource="ParentTasksCollection"
                                                     Value="@SelectedEditProjectTaskParentTask"
                                                     OnValueChanged="OnEditProjectTaskParentChanged"
                                                     Cache="__MemoryCache"
                                                     Multiselect="false" />
                                        </div>
                                    </Field>
                                </Column>
                            </Row>

                            <Row Class="g-3 mt-1">
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["Code"] *</FieldLabel>
                                        <TextEdit Text="@EditingProjectTask.Code" 
                                                  TextChanged="@((string value) => { EditingProjectTask.Code = value; EditFieldErrors.Remove("Code"); })"
                                                  MaxLength="ProjectTaskConsts.CodeMaxLength" 
                                                  Autofocus="true"
                                                  ReadOnly="true"
                                                  Style="@(HasEditFieldError("Code") ? "border-color: #dc3545;" : "")" />
                                        @if (HasEditFieldError("Code"))
                                        {
                                            <div class="invalid-feedback d-block">@GetEditFieldError("Code")</div>
                                        }
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["Title"] *</FieldLabel>
                                        <TextEdit Text="@EditingProjectTask.Title" 
                                                  TextChanged="@((string value) => { EditingProjectTask.Title = value; EditFieldErrors.Remove("Title"); })"
                                                  MaxLength="ProjectTaskConsts.TitleMaxLength"
                                                  Style="@(HasEditFieldError("Title") ? "border-color: #dc3545;" : "")" />
                                        @if (HasEditFieldError("Title"))
                                        {
                                            <div class="invalid-feedback d-block">@GetEditFieldError("Title")</div>
                                        }
                                    </Field>
                                </Column>
                            </Row>

                            <Row Class="g-3 mt-1">
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["Priority"] *</FieldLabel>
                                        <div style="@(HasEditFieldError("Priority") ? "border: 1px solid #dc3545; border-radius: 0.25rem; padding: 2px;" : "")">
                                            <Select TValue="ProjectTaskPriority"
                                                    SelectedValue="@EditingProjectTaskPriority"
                                                    SelectedValueChanged="@((ProjectTaskPriority value) => { OnEditingProjectTaskPriorityChanged(value); EditFieldErrors.Remove("Priority"); })">
                                                <ChildContent>
                                                    @foreach (var priority in Enum.GetValues<ProjectTaskPriority>())
                                                    {
                                                        <SelectItem TValue="ProjectTaskPriority" Value="@priority">
                                                            @L[$"Enum:ProjectTaskPriority.{priority}"]
                                                        </SelectItem>
                                                    }
                                                </ChildContent>
                                            </Select>
                                        </div>
                                        @if (HasEditFieldError("Priority"))
                                        {
                                            <div class="invalid-feedback d-block">@GetEditFieldError("Priority")</div>
                                        }
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["Status"] *</FieldLabel>
                                        <div style="@(HasEditFieldError("Status") ? "border: 1px solid #dc3545; border-radius: 0.25rem; padding: 2px;" : "")">
                                            <Select TValue="ProjectTaskStatus"
                                                    SelectedValue="@EditingProjectTaskStatus"
                                                    SelectedValueChanged="@((ProjectTaskStatus value) => { OnEditingProjectTaskStatusChanged(value); EditFieldErrors.Remove("Status"); })">
                                                <ChildContent>
                                                    @foreach (var status in Enum.GetValues<ProjectTaskStatus>())
                                                    {
                                                        <SelectItem TValue="ProjectTaskStatus" Value="@status">
                                                            @L[$"Enum:ProjectTaskStatus.{status}"]
                                                        </SelectItem>
                                                    }
                                                </ChildContent>
                                            </Select>
                                        </div>
                                        @if (HasEditFieldError("Status"))
                                        {
                                            <div class="invalid-feedback d-block">@GetEditFieldError("Status")</div>
                                        }
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["ProgressPercent"]</FieldLabel>
                                        <NumericPicker TValue="int"
                                                       Value="@EditingProjectTask.ProgressPercent"
                                                       ValueChanged="@((int value) => { EditingProjectTask.ProgressPercent = value; EditFieldErrors.Remove("ProgressPercent"); })"
                                                       Min="ProjectTaskConsts.ProgressPercentMinLength"
                                                       Max="ProjectTaskConsts.ProgressPercentMaxLength"
                                                       Decimals="0"
                                                       Style="@(HasEditFieldError("ProgressPercent") ? "border-color: #dc3545;" : "")" />
                                        @if (HasEditFieldError("ProgressPercent"))
                                        {
                                            <div class="invalid-feedback d-block">@GetEditFieldError("ProgressPercent")</div>
                                        }
                                    </Field>
                                </Column>
                            </Row>

                            @* DatePicker is outside any Validations to avoid Blazorise validator inference errors. *@
                            <Row Class="g-3 mt-1">
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["StartDate"]</FieldLabel>
                                        <Addons>
                                            <Addon AddonType="AddonType.Body">
                                                <DatePicker TValue="DateTime"
                                                            InputMode="DateInputMode.DateTime"
                                                            Date="@EditingProjectTask.StartDate"
                                                            DateChanged="@(v => EditingProjectTask.StartDate = v)"
                                                            Placeholder="@string.Empty"
                                                            DisplayFormat="dd/MM/yyyy HH:mm"
                                                            InputFormat="dd/MM/yyyy HH:mm"
                                                            @ref="@EditProjectTaskStartDateDatePicker" />
                                            </Addon>
                                            <Addon AddonType="AddonType.End">
                                                <Button Color="Color.Light" Clicked="@(() => EditProjectTaskStartDateDatePicker?.ToggleAsync())">
                                                    <Icon Name="IconName.CalendarDay" />
                                                </Button>
                                            </Addon>
                                        </Addons>
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["DueDate"]</FieldLabel>
                                        <Addons>
                                            <Addon AddonType="AddonType.Body">
                                                <DatePicker TValue="DateTime"
                                                            InputMode="DateInputMode.DateTime"
                                                            Date="@EditingProjectTask.DueDate"
                                                            DateChanged="@(v => EditingProjectTask.DueDate = v)"
                                                            Placeholder="@string.Empty"
                                                            DisplayFormat="dd/MM/yyyy HH:mm"
                                                            InputFormat="dd/MM/yyyy HH:mm"
                                                            @ref="@EditProjectTaskDueDateDatePicker" />
                                            </Addon>
                                            <Addon AddonType="AddonType.End">
                                                <Button Color="Color.Light" Clicked="@(() => EditProjectTaskDueDateDatePicker?.ToggleAsync())">
                                                    <Icon Name="IconName.CalendarDay" />
                                                </Button>
                                            </Addon>
                                        </Addons>
                                    </Field>
                                </Column>
                            </Row>

                            <Row Class="g-3 mt-1">
                                <Column ColumnSize="ColumnSize.Is12">
                                    <Field>
                                        <FieldLabel>@L["Description"]</FieldLabel>
                                        <MemoEdit @bind-Text="@EditingProjectTask.Description" />
                                    </Field>
                                </Column>
                            </Row>
                        </TabPanel>

                        <TabPanel Name="assignments">
                            <Row Class="g-3 align-items-center">
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["Assignee"] *</FieldLabel>
                                        <div class="hc-select2-full">
                                            <Select2 IdSelector="c => c.Id.ToString()"
                                                    TextSelector="c => c.DisplayName"
                                                    FilterFunction="GetAssignmentIdentityUserLookupAsync"
                                                    GetElementById="async (items, id, token) => items.Where(x => x.Id.ToString() == id).FirstOrDefault()!"
                                                    Datasource="AssignmentIdentityUsersCollection"
                                                    Value="@EditAssignmentsUsersToAdd"
                                                    OnValueChanged="OnEditAssignmentUserChanged"
                                                    Cache="__MemoryCache"
                                                    Multiselect="false" />
                                        </div>
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is3.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["AssignmentRole"] *</FieldLabel>
                                        <Select TValue="ProjectTaskAssignmentRole" @bind-SelectedValue="EditAssignmentRole" Class="w-100">
                                            @foreach (var role in Enum.GetValues<ProjectTaskAssignmentRole>())
                                            {
                                                <SelectItem TValue="ProjectTaskAssignmentRole" Value="@role">
                                                    @L[$"Enum:ProjectTaskAssignmentRole.{role}"]
                                                </SelectItem>
                                            }
                                        </Select>
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is3.OnDesktop">
                                    <Button Color="Color.Primary" Class="w-100" Clicked="AddEditAssignmentAsync">
                                        <Icon Name="IconName.Add" Class="me-1" /> @L["Add"]
                                    </Button>
                                </Column>
                            </Row>
                            <Row Class="g-3 mt-1">
                                <Column ColumnSize="ColumnSize.Is12">
                                    <Field>
                                        <FieldLabel>@L["Note"]</FieldLabel>
                                        <TextEdit @bind-Text="EditAssignmentNote" />
                                    </Field>
                                </Column>
                            </Row>

                            <DataGrid TItem="ProjectTaskAssignmentWithNavigationPropertiesDto"
                                      Data="EditAssignmentsList"
                                      Responsive="true"
                                      ShowPager="false">
                                <EmptyTemplate>
                                    <Row Class="w-100 align-items-center" Style="height: 120px;">
                                        <Column>
                                            <Heading Size="HeadingSize.Is6" TextAlignment="TextAlignment.Center">@L["CreateWizard:NoAssignees"]</Heading>
                                        </Column>
                                    </Row>
                                </EmptyTemplate>
                                <DataGridColumns>
                                    <DataGridColumn TItem="ProjectTaskAssignmentWithNavigationPropertiesDto" Field="User.UserName" Caption="@L["UserName"]" />
                                    <DataGridColumn TItem="ProjectTaskAssignmentWithNavigationPropertiesDto" Field="ProjectTaskAssignment.AssignmentRole" Caption="@L["AssignmentRole"]">
                                        <DisplayTemplate>
                                            @if (Enum.TryParse<ProjectTaskAssignmentRole>(context.ProjectTaskAssignment.AssignmentRole, ignoreCase: true, out var role))
                                            {
                                                @L[$"Enum:ProjectTaskAssignmentRole.{role}"]
                                            }
                                            else
                                            {
                                                @context.ProjectTaskAssignment.AssignmentRole
                                            }
                                        </DisplayTemplate>
                                    </DataGridColumn>
                                    <DataGridColumn TItem="ProjectTaskAssignmentWithNavigationPropertiesDto" Field="ProjectTaskAssignment.AssignedAt" Caption="@L["AssignedAt"]">
                                        <DisplayTemplate>
                                            @context.ProjectTaskAssignment.AssignedAt.ToString("dd/MM/yyyy HH:mm")
                                        </DisplayTemplate>
                                    </DataGridColumn>
                                    <DataGridColumn TItem="ProjectTaskAssignmentWithNavigationPropertiesDto" Field="ProjectTaskAssignment.Note" Caption="@L["Note"]" />
                                    <DataGridColumn TItem="ProjectTaskAssignmentWithNavigationPropertiesDto" Caption="@L["Actions"]">
                                        <DisplayTemplate>
                                            <Button Color="Color.Danger" Outline Size="Size.Small" Clicked="@(() => DeleteEditAssignmentAsync(context))">
                                                <Icon Name="IconName.Delete" Class="me-1" /> @L["Delete"]
                                            </Button>
                                        </DisplayTemplate>
                                    </DataGridColumn>
                                </DataGridColumns>
                            </DataGrid>
                        </TabPanel>

                        <TabPanel Name="documents">
                            <Row Class="g-3 align-items-center">
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is6.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["Document"]</FieldLabel>
                                        <div class="hc-select2-full">
                                            <Select2 IdSelector="c => c.Id.ToString()"
                                                    TextSelector="c => c.DisplayName"
                                                    FilterFunction="GetDocumentLookupAsync"
                                                    GetElementById="async (items, id, token) => items.Where(x => x.Id.ToString() == id).FirstOrDefault()!"
                                                    Datasource="DocumentsLookupCollection"
                                                    Value="@EditDocumentsToAdd"
                                                    OnValueChanged="OnEditDocumentChanged"
                                                    Cache="__MemoryCache"
                                                    Multiselect="false" />
                                        </div>
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is3.OnDesktop">
                                    <Field>
                                        <FieldLabel>@L["DocumentPurpose"]</FieldLabel>
                                        <Select TValue="ProjectTaskDocumentPurpose" @bind-SelectedValue="EditDocumentPurpose" Class="w-100">
                                            @foreach (var purpose in Enum.GetValues<ProjectTaskDocumentPurpose>())
                                            {
                                                <SelectItem TValue="ProjectTaskDocumentPurpose" Value="@purpose">
                                                    @L[$"Enum:ProjectTaskDocumentPurpose.{purpose}"]
                                                </SelectItem>
                                            }
                                        </Select>
                                    </Field>
                                </Column>
                                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is3.OnDesktop">
                                    <Button Color="Color.Primary" Class="w-100" Clicked="AddEditDocumentAsync">
                                        <Icon Name="IconName.Add" Class="me-1" /> @L["Add"]
                                    </Button>
                                </Column>
                            </Row>

                            <DataGrid TItem="ProjectTaskDocumentWithNavigationPropertiesDto"
                                      Data="EditDocumentsList"
                                      Responsive="true"
                                      ShowPager="false">
                                <EmptyTemplate>
                                    <Row Class="w-100 align-items-center" Style="height: 120px;">
                                        <Column>
                                            <Heading Size="HeadingSize.Is6" TextAlignment="TextAlignment.Center">@L["CreateWizard:NoDocuments"]</Heading>
                                        </Column>
                                    </Row>
                                </EmptyTemplate>
                                <DataGridColumns>
                                    <DataGridColumn TItem="ProjectTaskDocumentWithNavigationPropertiesDto" Field="Document.Title" Caption="@L["Title"]" />
                                    <DataGridColumn TItem="ProjectTaskDocumentWithNavigationPropertiesDto" Field="ProjectTaskDocument.DocumentPurpose" Caption="@L["DocumentPurpose"]">
                                        <DisplayTemplate>
                                            @if (context.ProjectTaskDocument != null && !string.IsNullOrWhiteSpace(context.ProjectTaskDocument.DocumentPurpose))
                                            {
                                                @if (Enum.TryParse<ProjectTaskDocumentPurpose>(context.ProjectTaskDocument.DocumentPurpose, ignoreCase: true, out var purpose))
                                                {
                                                    @L[$"Enum:ProjectTaskDocumentPurpose.{purpose}"]
                                                }
                                                else
                                                {
                                                    @context.ProjectTaskDocument.DocumentPurpose
                                                }
                                            }
                                        </DisplayTemplate>
                                    </DataGridColumn>
                                    <DataGridColumn TItem="ProjectTaskDocumentWithNavigationPropertiesDto" Caption="@L["Actions"]">
                                        <DisplayTemplate>
                                            <div class="d-flex gap-2">
                                                @if (context.Document != null)
                                                {
                                                    @if (DocumentHasPdfFile(context.Document.Id))
                                                    {
                                                        <Button Color="Color.Info" Size="Size.Small" Clicked="@(() => OpenPdfViewerModalForDocumentAsync(context))" Title="@L["ViewFile"]">
                                                            <Icon Name="IconName.Eye" />
                                                        </Button>
                                                    }
                                                    <Button Color="Color.Primary" Size="Size.Small" Clicked="@(() => DownloadDocumentFileAsync(context))" Title="@L["Download"]">
                                                        <Icon Name="IconName.Download" />
                                                    </Button>
                                                }
                                                <Button Color="Color.Danger" Outline Size="Size.Small" Clicked="@(() => DeleteEditDocumentAsync(context))" Title="@L["Delete"]">
                                                    <Icon Name="IconName.Delete" />
                                                </Button>
                                            </div>
                                        </DisplayTemplate>
                                    </DataGridColumn>
                                </DataGridColumns>
                            </DataGrid>
                        </TabPanel>
                    </Content>
                </Tabs>
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary"
                        Clicked="CloseEditProjectTaskModalAsync">
                    @L["Cancel"]
                </Button>
                <SubmitButton Form="EditProjectTaskForm" Clicked="UpdateProjectTaskAsync" />
@*//<suite-custom-code-block-9>*@
@*//</suite-custom-code-block-9>*@
            </ModalFooter>
        </Form>
@*//<suite-custom-code-block-10>*@
@*//</suite-custom-code-block-10>*@
    </ModalContent>
</Modal>
@* ************************* PDF VIEWER MODAL ************************* *@
<Modal @ref="PdfViewerModal" Class="pdf-viewer-modal" Size="ModalSize.ExtraLarge" Centered="true">
    <ModalContent>
        <ModalHeader>
            <ModalTitle>@L["DocumentPreview"]</ModalTitle>
            <CloseButton Clicked="ClosePdfViewerModalAsync" />
        </ModalHeader>
        <ModalBody Class="pdf-viewer-modal-body">
            @if (IsPdfFile && !string.IsNullOrEmpty(PdfFileUrl))
            {
                <PdfViewerContainer Height="Height.Rem(35)">
                    <PdfViewerToolbar />
                    <PdfViewer Source="@PdfFileUrl" />
                </PdfViewerContainer>
            }
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="ClosePdfViewerModalAsync">
                @L["Close"]
            </Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<style>
    /* PDF Viewer Modal - Ensure it stays within modal */
    .pdf-viewer-modal .modal-content {
        position: relative;
        z-index: 1050;
    }

    .pdf-viewer-modal .modal-header {
        border-bottom: 1px solid #dee2e6;
    }

    .pdf-viewer-modal .modal-body {
        max-height: 90vh;
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    .pdf-viewer-modal-body {
        max-height: 50rem;
        overflow: hidden;
        position: relative;
    }
</style>
