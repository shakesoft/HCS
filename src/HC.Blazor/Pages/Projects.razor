@page "/projects"
@attribute [Authorize(HCPermissions.Projects.Default)]
@using HC.Projects
@using HC.Localization
@using HC.Shared
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Localization
@using Microsoft.AspNetCore.Components.Web
@using Blazorise
@using Blazorise.Components
@using Blazorise.DataGrid
@using Volo.Abp.BlazoriseUI
@using Volo.Abp.BlazoriseUI.Components
@using Volo.Abp.ObjectMapping
@using Volo.Abp.AspNetCore.Components.Messages
@using Volo.Abp.AspNetCore.Components.Web.Theming.Layout
@using HC.Permissions
@using Volo.Abp.AspNetCore.Components.Web
@using Volo.Abp.AspNetCore.Components
@using Microsoft.AspNetCore.Components
@using Volo.Abp.Http.Client
@using Microsoft.Extensions.Caching.Memory
@using HC.ProjectMembers
@using HC.ProjectTasks
@inherits HCComponentBase
@inject IMemoryCache __MemoryCache
@inject IProjectsAppService ProjectsAppService
@inject IProjectMembersAppService ProjectMembersAppService
@inject IProjectTasksAppService ProjectTasksAppService
@inject IUiMessageService UiMessageService
@inject AbpBlazorMessageLocalizerHelper<HCResource> LH
@inject IRemoteServiceConfigurationProvider RemoteServiceConfigurationProvider
@inject NavigationManager NavigationManager
@* ************************* PAGE HEADER ************************* *@
<PageHeader Title="@L["Projects"]" BreadcrumbItems="BreadcrumbItems" Toolbar="Toolbar">
</PageHeader>
<style>
    tr.table-row-selectable:hover {
        cursor: default;
    }

    .select2-container--default .select2-selection--multiple
    {
        padding: 0.3rem .25rem !important;
        background-color: #e8eef3 !important;
        border-radius: 0.5rem;
        transition: background-color 0.2s, border-color 0.4s;
        border: 1px solid #e8eef3 !important;
    }

    /* Colored action icons */
    .hc-action-icons {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.75rem;
    }

    .hc-action-icon {
        font-size: 1.1rem;
        transition: opacity 0.2s, transform 0.2s;
    }

    .hc-action-icon:hover {
        opacity: 0.8;
        transform: scale(1.1);
    }

    .hc-action-edit {
        color: #7A6FF0 !important;
    }

    .hc-action-view {
        color: #0d6efd !important;
    }

    .hc-action-tasks {
        color: #198754 !important;
    }

    .hc-action-members {
        color: #0dcaf0 !important;
    }

    .hc-action-delete {
        color: #EB4D4B !important;
    }
</style>
@* ************************* SEARCH ************************* *@
<Card>
    <CardBody>
@*//<suite-custom-code-block-1>*@
@*//</suite-custom-code-block-1>*@
        <Row>
            <div class="col col-md-8 col-lg-10">
                <div class="mb-3">
                    <Form id="ProjectSearchForm">
                        <Addons>
                            <Addon AddonType="AddonType.Body">
                                <TextEdit @bind-Text="@Filter.FilterText"
                                        Autofocus="true"
                                        Placeholder="@L["Search"]">
                                </TextEdit>
                            </Addon>
                            <Addon AddonType="AddonType.End">
                                <SubmitButton Form="ProjectSearchForm" Clicked="GetProjectsAsync">
                                    <Icon Name="IconName.Search" Class="me-1"></Icon>@L["Search"]
                                </SubmitButton>
                            </Addon>
                        </Addons>
                    </Form>
                </div>
            </div>
                   <div class="col-md-4 col-lg-2">
            <div class="mb-3">
               <Button Color="Color.Primary" Outline Style="width:100%" id="AdvancedFilterSectionToggler"
                         Clicked="@(() => ShowAdvancedFilters = !ShowAdvancedFilters)">@L["Filters"]
                         <i aria-hidden="true" class="fa ms-1 @(!ShowAdvancedFilters ? "fa-angle-down" : "fa-angle-up")"></i>
               </Button>
            </div>
       </div>
        <div style="display: @(!ShowAdvancedFilters ? "none" : "block")"  class="mt-3">
            <Row>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["Code"]</FieldLabel>
                        <TextEdit Text="@Filter.Code" TextChanged="@OnCodeChangedAsync" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["Name"]</FieldLabel>
                        <TextEdit Text="@Filter.Name" TextChanged="@OnNameChangedAsync" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["Description"]</FieldLabel>
                        <TextEdit Text="@Filter.Description" TextChanged="@OnDescriptionChangedAsync" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["MinStartDate"]</FieldLabel>
                        <DatePicker TValue="DateTime?"
            InputMode="DateInputMode.Date"
            Date="@Filter.StartDateMin"
            DateChanged="@OnStartDateMinChangedAsync"
            Placeholder="@string.Empty" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["MaxStartDate"]</FieldLabel>
                        <DatePicker TValue="DateTime?"
            InputMode="DateInputMode.Date"
            Date="@Filter.StartDateMax"
            DateChanged="@OnStartDateMaxChangedAsync"
            Placeholder="@string.Empty" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["MinEndDate"]</FieldLabel>
                        <DatePicker TValue="DateTime?"
            InputMode="DateInputMode.Date"
            Date="@Filter.EndDateMin"
            DateChanged="@OnEndDateMinChangedAsync"
            Placeholder="@string.Empty" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["MaxEndDate"]</FieldLabel>
                        <DatePicker TValue="DateTime?"
            InputMode="DateInputMode.Date"
            Date="@Filter.EndDateMax"
            DateChanged="@OnEndDateMaxChangedAsync"
            Placeholder="@string.Empty" />                       
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["Status"]</FieldLabel>
                        <Select TValue="ProjectStatus?" SelectedValue="@Filter.Status" SelectedValueChanged="@OnStatusChangedAsync">
                            <SelectItem TValue="ProjectStatus?" Value="@((ProjectStatus?)null)">@L["All"]</SelectItem>
                            @foreach (var status in Enum.GetValues<ProjectStatus>())
                            {
                                <SelectItem TValue="ProjectStatus?" Value="@status">
                                    @L[$"Enum:ProjectStatus.{status}"]
                                </SelectItem>
                            }
                        </Select>
                    </Field>
                </Column>
                <Column ColumnSize="ColumnSize.Is3">
                    <Field>
                        <FieldLabel>@L["Department"]</FieldLabel>
                        <Select TValue="Guid?"
		SelectedValue="@Filter.OwnerDepartmentId"
		SelectedValueChanged="@OnOwnerDepartmentIdChangedAsync">
<SelectItem></SelectItem>
@foreach(var item in DepartmentsCollection)
{
	<SelectItem TValue="Guid?" Value="@item.Id">
		@item.DisplayName
	</SelectItem>
}
</Select>                       
                    </Field>
                </Column>
            </Row>
@*//<suite-custom-code-block-2>*@
@*//</suite-custom-code-block-2>*@
        </div>
        </Row>
@*//<suite-custom-code-block-3>*@
@*//</suite-custom-code-block-3>*@
    </CardBody>
</Card>
@* ************************* DATA GRID ************************* *@
<Card>
    <CardBody>        
        <Div  Visibility="@(SelectedProjects.Any() ? Visibility.Visible : Visibility.Invisible)"
              class="d-flex justify-content-between align-items-center mb-2">
              <p class="lead mb-0">
                @if (AllProjectsSelected)
                {
                    @L["AllItemsAreSelected", TotalCount]
                }
                else
                {
                    @if (SelectedProjects.Count > 1)
                    {
                        @L["NumberOfItemsOnThisPageAreSelected", SelectedProjects.Count]
                    }
                    else
                    {
                        @L["OneItemOnThisPageIsSelected"]
                    }
                }
              </p>
            <div>
                @if ((SelectedProjects.Count == PageSize || SelectedProjects.Count == ProjectList.Count) && TotalCount > SelectedProjects.Count)
                {
                    if (!AllProjectsSelected)
                    {
                        <Button Clicked="SelectAllItems" Class="mx-1 btn-outline-secondary">@L["SelectAllItems", TotalCount]</Button>
                    }
                    else
                    {
                        <Button Clicked="ClearSelection" Class="mx-1 btn-outline-secondary">@L["ClearSelection"]</Button>
                    }
                }
                <Button Color="Color.Danger" Class="mx-1" Size="Size.Medium" Clicked="DeleteSelectedProjectsAsync">
                    <Icon Name="@IconName.Delete" /> @L["Delete"]
                </Button>
            </div>
        </Div>
        <hr Visibility="@(SelectedProjects.Any() ? Visibility.Visible : Visibility.Invisible)"
            class="my-1 mx-0" />
        <DataGrid TItem="ProjectWithNavigationPropertiesDto"
                  @ref="DataGridRef"
                  Data="ProjectList"
                  SelectionMode="DataGridSelectionMode.Multiple"
                  SelectedRows="SelectedProjects"
                  RowSelectable="RowSelectableHandler"
                  SelectedRowsChanged="SelectedProjectRowsChanged"
                  ReadData="OnDataGridReadAsync"
                  TotalItems="TotalCount"
                  ShowPager="true"
                  Responsive="true"
                  PageSize="PageSize"
                  Class="datagrid-detail">
            <LoadingTemplate>
                <Row Class="w-100 align-items-center" Style="height: 150px;">
                    <Column>
                       <RadarSpinner />
                    </Column>
                </Row>
            </LoadingTemplate>
            <EmptyTemplate>
                <Row Class="w-100 align-items-center" Style="height: 150px;">
                    <Column>
                        <Heading Size="HeadingSize.Is4" TextAlignment="TextAlignment.Center">@L["NoDataAvailable"]</Heading>
                    </Column>
                </Row>
            </EmptyTemplate>   
            <DataGridColumns>
                @if (CanDeleteProject && ProjectList.Any())
                {
                    <DataGridMultiSelectColumn TItem="ProjectWithNavigationPropertiesDto" DisplayOrder="-1" Width="30px"></DataGridMultiSelectColumn>
                }
              <DataGridColumn TItem="ProjectWithNavigationPropertiesDto"
                      Field="Project.Code"
                      Caption="@L["Code"]"
                      CellStyle="@((item) => "min-width: 150px")"
                      Width="150px">
              </DataGridColumn>
              <DataGridColumn TItem="ProjectWithNavigationPropertiesDto"
                      Field="Project.Name"
                      Caption="@L["Name"]"
                      CellStyle="@((item) => "min-width: 150px")"
                      Width="150px">
              </DataGridColumn>
              <DataGridColumn TItem="ProjectWithNavigationPropertiesDto"
                      Field="Project.Description"
                      Caption="@L["Description"]"
                      CellStyle="@((item) => "min-width: 300px")"
                      Width="300px">
                  <DisplayTemplate>
                      @{
                          var description = context.Project?.Description ?? string.Empty;
                          var displayText = description.Length > 100 ? description.Substring(0, 100) + "..." : description;
                      }
                      <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="@description">
                          @displayText
                      </div>
                  </DisplayTemplate>
              </DataGridColumn>
              <DataGridColumn TItem="ProjectWithNavigationPropertiesDto"
                      Field="Project.StartDate"
                      Caption="@L["StartDate"]"
                      CellStyle="@((item) => "min-width: 200px")"
                      Width="200px">
                  <DisplayTemplate>
                        @context.Project.StartDate.ToString("dd/MM/yyyy HH:mm")
                  </DisplayTemplate>
              </DataGridColumn>
              <DataGridColumn TItem="ProjectWithNavigationPropertiesDto"
                      Field="Project.EndDate"
                      Caption="@L["EndDate"]"
                      CellStyle="@((item) => "min-width: 200px")"
                      Width="200px">
                  <DisplayTemplate>
                        @context.Project.EndDate.ToString("dd/MM/yyyy HH:mm")
                  </DisplayTemplate>
              </DataGridColumn>
              <DataGridColumn TItem="ProjectWithNavigationPropertiesDto"
                      Field="Project.Status"
                      Caption="@L["Status"]"
                      CellStyle="@((item) => "min-width: 150px")"
                      Width="150px">
                  <DisplayTemplate>
                      @if (context.Project != null)
                      {
                          @L[$"Enum:ProjectStatus.{context.Project.Status}"]
                      }
                  </DisplayTemplate>
              </DataGridColumn>
              <DataGridColumn TItem="ProjectWithNavigationPropertiesDto"
                      Field="OwnerDepartment.Name"
                      Caption="@L["Department"]"
                      CellStyle="@((item) => "min-width: 150px")"
                      Width="150px">
              </DataGridColumn>
              <DataGridColumn TItem="ProjectWithNavigationPropertiesDto"
                      Caption="@L["NumberOfMembers"]"
                      CellStyle="@((item) => "min-width: 150px")"
                      Width="150px">
                  <DisplayTemplate>
                      @context.ProjectMemberCount
                  </DisplayTemplate>
              </DataGridColumn>
              <DataGridColumn TItem="ProjectWithNavigationPropertiesDto"
                      Caption="@L["NumberOfTasks"]"
                      CellStyle="@((item) => "min-width: 150px")"
                      Width="150px">
                  <DisplayTemplate>
                      @context.ProjectTaskCount
                  </DisplayTemplate>
              </DataGridColumn>
                <DataGridColumn TItem="ProjectWithNavigationPropertiesDto" Caption="@L["Actions"]">
                    <DisplayTemplate>
                        <div class="hc-action-icons">
                            @if (CanEditProject)
                            {
                                <i class="bi bi-pencil-fill hc-action-icon hc-action-edit" 
                                   title="@L["Edit"]"
                                   @onclick="@(() => OpenEditProjectModalAsync(context))"
                                   style="cursor: pointer;"></i>
                            }
                            <i class="bi bi-eye-fill hc-action-icon hc-action-view" 
                               title="@L["Menu:ProjectDetail"]"
                               @onclick="@(() => NavigateToProjectDetail(context))"
                               style="cursor: pointer;"></i>
                            <i class="bi bi-card-checklist hc-action-icon hc-action-tasks" 
                               title="@L["Tasks"]"
                               @onclick="@(() => OpenProjectTasksModalAsync(context))"
                               style="cursor: pointer;"></i>
                            <i class="bi bi-people-fill hc-action-icon hc-action-members" 
                               title="@L["Members"]"
                               @onclick="@(() => OpenProjectMembersModalAsync(context))"
                               style="cursor: pointer;"></i>
                            @if (CanDeleteProject)
                            {
                                <i class="bi bi-trash-fill hc-action-icon hc-action-delete" 
                                   title="@L["Delete"]"
                                   @onclick="@(() => DeleteProjectWithConfirmationAsync(context))"
                                   style="cursor: pointer;"></i>
                            }
                        </div>
@*//<suite-custom-code-block-4>*@
@*//</suite-custom-code-block-4>*@
                    </DisplayTemplate>
                </DataGridColumn>
            </DataGridColumns>
        </DataGrid>
    </CardBody>
</Card>
@* ************************* CREATE MODAL ************************* *@
<Modal @ref="CreateProjectModal" Closing="@CreateProjectModal.CancelClosingModalWhenFocusLost">
    <ModalContent Centered="true">
@*//<suite-custom-code-block-5>*@
@*//</suite-custom-code-block-5>*@
        <Form id="CreateProjectForm">
            <ModalHeader>
                <ModalTitle>@L["NewProject"]</ModalTitle>
                <CloseButton Clicked="CloseCreateProjectModalAsync" />
            </ModalHeader>
            <ModalBody>
                @* Manual validation is used (see ValidateCreateProject). *@
                @if (!string.IsNullOrWhiteSpace(CreateProjectValidationErrorKey))
                {
                    <Alert Color="Color.Danger">
                        <AlertMessage>@L["NotificationError"]!</AlertMessage>
                        <AlertDescription>@L[CreateProjectValidationErrorKey]</AlertDescription>
                    </Alert>
                }
                <Form>
                    <Field>
                        <FieldLabel>@L["Code"] *</FieldLabel>
                        <TextEdit Text="@NewProject.Code" 
                                  TextChanged="@((string value) => { NewProject.Code = value; CreateFieldErrors.Remove("Code"); })"
                                  MaxLength="ProjectConsts.CodeMaxLength" 
                                  Autofocus="true"
                                  ReadOnly="true"
                                  Style="@(HasCreateFieldError("Code") ? "border-color: #dc3545;" : "")" />
                        @if (HasCreateFieldError("Code"))
                        {
                            <div class="invalid-feedback d-block">@GetCreateFieldError("Code")</div>
                        }
                    </Field>
                    <Field>
                        <FieldLabel>@L["Name"] *</FieldLabel>
                        <TextEdit Text="@NewProject.Name" 
                                  TextChanged="@((string value) => { NewProject.Name = value; CreateFieldErrors.Remove("Name"); })"
                                  MaxLength="ProjectConsts.NameMaxLength"
                                  Style="@(HasCreateFieldError("Name") ? "border-color: #dc3545;" : "")" />
                        @if (HasCreateFieldError("Name"))
                        {
                            <div class="invalid-feedback d-block">@GetCreateFieldError("Name")</div>
                        }
                    </Field>
                    <Field>
                        <FieldLabel>@L["Description"]</FieldLabel>
                        <MemoEdit @bind-Text="@NewProject.Description" />
                    </Field>
                    <Field>
                        <FieldLabel>@L["StartDate"]</FieldLabel>
                        <Addons>
                            <Addon AddonType="AddonType.Body">
                                <DatePicker TValue="DateTime"
                                            InputMode="DateInputMode.DateTime"
                                            Date="@NewProject.StartDate"
                                            DateChanged="@(v => NewProject.StartDate = v)"
                                            Placeholder="@string.Empty"
                                            DisplayFormat="dd/MM/yyyy HH:mm"
                                            InputFormat="dd/MM/yyyy HH:mm"
                                            @ref="@NewProjectStartDateDatePicker" />
                            </Addon>
                            <Addon AddonType="AddonType.End">
                                <Button Color="Color.Light" Clicked="@(() => NewProjectStartDateDatePicker?.ToggleAsync())">
                                    <Icon Name="IconName.CalendarDay" />
                                </Button>
                            </Addon>
                        </Addons>
                    </Field>
                    <Field>
                        <FieldLabel>@L["EndDate"]</FieldLabel>
                        <Addons>
                            <Addon AddonType="AddonType.Body">
                                <DatePicker TValue="DateTime"
                                            InputMode="DateInputMode.DateTime"
                                            Date="@NewProject.EndDate"
                                            DateChanged="@(v => NewProject.EndDate = v)"
                                            Placeholder="@string.Empty"
                                            DisplayFormat="dd/MM/yyyy HH:mm"
                                            InputFormat="dd/MM/yyyy HH:mm"
                                            @ref="@NewProjectEndDateDatePicker" />
                            </Addon>
                            <Addon AddonType="AddonType.End">
                                <Button Color="Color.Light" Clicked="@(() => NewProjectEndDateDatePicker?.ToggleAsync())">
                                    <Icon Name="IconName.CalendarDay" />
                                </Button>
                            </Addon>
                        </Addons>
                    </Field>
                    <Field>
                        <FieldLabel>@L["Status"] *</FieldLabel>
                        <Select TValue="ProjectStatus" 
                                SelectedValue="@NewProject.Status"
                                SelectedValueChanged="@((ProjectStatus value) => { NewProject.Status = value; })">
                            <ChildContent>
                                @foreach (var status in Enum.GetValues<ProjectStatus>())
                                {
                                    <SelectItem TValue="ProjectStatus" Value="@status">
                                        @L[$"Enum:ProjectStatus.{status}"]
                                    </SelectItem>
                                }
                            </ChildContent>
                        </Select>
                    </Field>
                    <Field>
                        <FieldLabel>@L["Department"]</FieldLabel>
                        <Select2 IdSelector="c => c.Id.ToString()"
                                    TextSelector="c => c.DisplayName"
                                    FilterFunction="GetDepartmentCollectionLookupAsync"
                                    GetElementById="async (items, id, token) => items.FirstOrDefault(x => x.Id.ToString() == id)!"
                                    Datasource="DepartmentsCollection"
                                    Value="@SelectedDepartment"
                                    OnValueChanged="OnDepartmentIdChanged"                
                                    Cache="__MemoryCache"
                                    Multiselect="false" />
                    </Field>
                </Form>
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary"
                        Clicked="CloseCreateProjectModalAsync">
                    @L["Cancel"]
                </Button>
                <Button Color="Color.Primary" Clicked="CreateProjectAsync">
                    @L["Save"]
                </Button>
@*//<suite-custom-code-block-6>*@
@*//</suite-custom-code-block-6>*@
            </ModalFooter>
        </Form>
@*//<suite-custom-code-block-7>*@
@*//</suite-custom-code-block-7>*@
    </ModalContent>
</Modal>

@* ************************* PROJECT TASKS MODAL ************************* *@
<Modal @ref="ProjectTasksModal" Closing="@ProjectTasksModal.CancelClosingModalWhenFocusLost">
    <ModalContent Centered="true" Size="ModalSize.ExtraLarge">
        <ModalHeader>
            <ModalTitle>@L["Tasks"] @(!string.IsNullOrWhiteSpace(ProjectTasksProjectDisplayName) ? $"— {ProjectTasksProjectDisplayName}" : string.Empty)</ModalTitle>
            <CloseButton Clicked="CloseProjectTasksModalAsync" />
        </ModalHeader>
        <ModalBody>
            <div class="hc-modal-toolbar">
                <Row Class="g-2 align-items-center">
                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is8.OnDesktop">
                        <TextEdit @bind-Text="ProjectTasksFilterText"
                                  Placeholder="@L["Search"]"
                                  Class="w-100" />
                    </Column>
                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                        <div class="hc-toolbar-actions">
                            <Button Color="Color.Primary" Size="Size.Small" Clicked="SearchProjectTasksAsync" Class="hc-btn-grow">
                                <Icon Name="IconName.Search" Class="me-1" /> @L["Search"]
                            </Button>
                            <Button Color="Color.Light" Size="Size.Small" Outline Clicked="RefreshProjectTasksAsync" Title="@L["Search"]">
                                <Icon Name="IconName.Sync" />
                            </Button>
                        </div>
                    </Column>
                </Row>
            </div>
            <DataGrid TItem="ProjectTaskWithNavigationPropertiesDto"
                      @ref="ProjectTasksDataGridRef"
                      Data="ProjectTasksList"
                      ReadData="OnProjectTasksGridReadAsync"
                      TotalItems="ProjectTasksTotalCount"
                      ShowPager="true"
                      Responsive="true"
                      PageSize="PageSize">
                <LoadingTemplate>
                    <Row Class="w-100 align-items-center" Style="height: 120px;">
                        <Column>
                            <RadarSpinner />
                        </Column>
                    </Row>
                </LoadingTemplate>
                <EmptyTemplate>
                    <Row Class="w-100 align-items-center" Style="height: 120px;">
                        <Column>
                            <Heading Size="HeadingSize.Is5" TextAlignment="TextAlignment.Center">@L["NoDataAvailable"]</Heading>
                        </Column>
                    </Row>
                </EmptyTemplate>
                <DataGridColumns>
                    <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto" Field="ProjectTask.Code" Caption="@L["Code"]" />
                    <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto" Field="ProjectTask.Title" Caption="@L["Title"]" />
                    <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto" Field="ProjectTask.Status" Caption="@L["Status"]">
                        <DisplayTemplate>
                            <Badge Color="Color.Info">@context.ProjectTask.Status</Badge>
                        </DisplayTemplate>
                    </DataGridColumn>
                    <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto" Field="ProjectTask.Priority" Caption="@L["Priority"]">
                        <DisplayTemplate>
                            <Badge Color="Color.Secondary">@context.ProjectTask.Priority</Badge>
                        </DisplayTemplate>
                    </DataGridColumn>
                    <DataGridColumn TItem="ProjectTaskWithNavigationPropertiesDto" Field="ProjectTask.ProgressPercent" Caption="@L["ProgressPercent"]">
                        <DisplayTemplate>
                            <div class="d-flex align-items-center gap-2">
                                <Progress Value="@context.ProjectTask.ProgressPercent" Max="100" Class="hc-progress" />
                                <span class="text-muted small">@context.ProjectTask.ProgressPercent%</span>
                            </div>
                        </DisplayTemplate>
                    </DataGridColumn>
                </DataGridColumns>
            </DataGrid>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Size="Size.Small" Clicked="CloseProjectTasksModalAsync">@L["Close"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@* ************************* PROJECT MEMBERS MODAL ************************* *@
<Modal @ref="ProjectMembersModal" Closing="@ProjectMembersModal.CancelClosingModalWhenFocusLost">
    <ModalContent Centered="true" Size="ModalSize.ExtraLarge">
        <ModalHeader>
            <ModalTitle>@L["Members"] @(!string.IsNullOrWhiteSpace(ProjectMembersProjectDisplayName) ? $"— {ProjectMembersProjectDisplayName}" : string.Empty)</ModalTitle>
            <CloseButton Clicked="CloseProjectMembersModalAsync" />
        </ModalHeader>
        <ModalBody>
            @* Row 1: Search (8) - Button Search (4) *@
            <Row Class="g-2 mb-1 align-items-center">
                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is8.OnDesktop">
                    <TextEdit @bind-Text="ProjectMembersFilterText"
                              Placeholder="@L["Search"]"
                              Class="w-100" />
                </Column>
                <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                    <Button Color="Color.Primary" Size="Size.Medium" Clicked="SearchProjectMembersAsync" Class="w-100">
                        <Icon Name="IconName.Search" Class="me-1" /> @L["Search"]
                    </Button>
                </Column>
            </Row>

            @if (CanCreateProjectMember)
            {
                <Row Class="g-2 mb-1 align-items-center">
                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                        <div class="hc-select2-full @(IsProjectMemberRoleEditMode ? "hc-disabled" : string.Empty)">
                            <Select2 IdSelector="c => c.Id.ToString()"
                                    TextSelector="c => c.DisplayName"
                                    FilterFunction="GetIdentityUserCollectionLookupAsync"
                                    GetElementById="async (items, id, token) => items.FirstOrDefault(x => x.Id.ToString() == id)!"
                                    Datasource="IdentityUsersCollection"
                                    Value="@ProjectMembersToAdd"
                                    OnValueChanged="OnProjectMembersToAddChanged"
                                    Cache="__MemoryCache"
                                    Multiselect="false" />
                        </div>
                    </Column>
                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                        <Select TValue="ProjectMemberRole" @bind-SelectedValue="ProjectMembersRoleToAdd" Class="w-100">
                            @foreach (var role in Enum.GetValues<ProjectMemberRole>())
                            {
                                <SelectItem TValue="ProjectMemberRole" Value="@role">
                                    @L[$"Enum:ProjectMemberRole.{role}"]
                                </SelectItem>
                            }
                        </Select>
                    </Column>
                    <Column ColumnSize="ColumnSize.Is12.OnMobile.Is4.OnDesktop">
                        <Button Color="Color.Primary"
                                Size="Size.Medium"
                                Disabled="@((!IsProjectMemberRoleEditMode && (ProjectMembersToAdd == null || ProjectMembersToAdd.Count == 0)) || (IsProjectMemberRoleEditMode && !CanEditProjectMember))"
                                Clicked="AddProjectMembersAsync"
                                Class="w-100">
                            @if (IsProjectMemberRoleEditMode)
                            {
                                <Icon Name="IconName.Save" Class="me-1" /> @L["Update"]
                            }
                            else
                            {
                                <Icon Name="IconName.Add" Class="me-1" /> @L["Add"]
                            }
                        </Button>
                    </Column>
                </Row>
            }
            <DataGrid TItem="ProjectMemberWithNavigationPropertiesDto"
                      @ref="ProjectMembersDataGridRef"
                      Data="ProjectMembersList"
                      ReadData="OnProjectMembersGridReadAsync"
                      TotalItems="ProjectMembersTotalCount"
                      ShowPager="true"
                      Responsive="true"
                      PageSize="PageSize">
                <LoadingTemplate>
                    <Row Class="w-100 align-items-center" Style="height: 120px;">
                        <Column>
                            <RadarSpinner />
                        </Column>
                    </Row>
                </LoadingTemplate>
                <EmptyTemplate>
                    <Row Class="w-100 align-items-center" Style="height: 120px;">
                        <Column>
                            <Heading Size="HeadingSize.Is5" TextAlignment="TextAlignment.Center">@L["NoDataAvailable"]</Heading>
                        </Column>
                    </Row>
                </EmptyTemplate>
                <DataGridColumns>
                    <DataGridColumn TItem="ProjectMemberWithNavigationPropertiesDto" Field="User.UserName" Caption="@L["UserName"]" />
                    <DataGridColumn TItem="ProjectMemberWithNavigationPropertiesDto" Field="ProjectMember.MemberRole" Caption="@L["MemberRole"]">
                        <DisplayTemplate>
                            <Badge Color="Color.Primary">@L[$"Enum:ProjectMemberRole.{context.ProjectMember.MemberRole}"]</Badge>
                        </DisplayTemplate>
                    </DataGridColumn>
                    <DataGridColumn TItem="ProjectMemberWithNavigationPropertiesDto" Field="ProjectMember.JoinedAt" Caption="@L["JoinedAt"]">
                        <DisplayTemplate>
                            @context.ProjectMember.JoinedAt.ToString("dd/MM/yyyy HH:mm")
                        </DisplayTemplate>
                    </DataGridColumn>
                    @if (CanEditProjectMember || CanDeleteProjectMember)
                    {
                        <DataGridColumn TItem="ProjectMemberWithNavigationPropertiesDto" Caption="@L["Actions"]">
                            <DisplayTemplate>
                                <div class="d-flex gap-2 flex-wrap justify-content-end">
                                    @if (CanEditProjectMember)
                                    {
                                        <Button Color="Color.Primary" Outline Size="Size.Small" Clicked="@(() => ToggleEditProjectMemberRoleAsync(context))">
                                            @(IsProjectMemberRoleEditMode && EditingProjectMemberIdInModal == context.ProjectMember.Id ? L["Cancel"].Value : L["Edit"].Value)
                                        </Button>
                                    }
                                    @if (CanDeleteProjectMember)
                                    {
                                        <Button Color="Color.Danger" Outline Size="Size.Small" Clicked="@(() => DeleteProjectMemberAsync(context))">
                                            <Icon Name="IconName.Delete" Class="me-1" /> @L["Delete"]
                                        </Button>
                                    }
                                </div>
                            </DisplayTemplate>
                        </DataGridColumn>
                    }
                </DataGridColumns>
            </DataGrid>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Size="Size.Small" Clicked="CloseProjectMembersModalAsync">@L["Close"]</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<style>
    .hc-modal-toolbar {
        margin-bottom: 0.75rem;
    }

    .hc-card-soft {
        border: 1px solid rgba(0,0,0,.06);
        background: rgba(13,110,253,.03);
    }

    .hc-progress {
        width: 140px;
        height: 8px;
    }

    /* Make select2 always full width */
    .hc-select2-full,
    .hc-select2-full > * {
        width: 100%;
        max-width: 100%;
    }

    .hc-select2-full .select2-container {
        width: 100% !important;
    }

    .hc-disabled {
        pointer-events: none;
        opacity: 0.75;
    }

    @@media (max-width: 576px) {
        .hc-progress {
            width: 100px;
        }
    }
</style>
@* ************************* EDIT MODAL ************************* *@
<Modal @ref="EditProjectModal" Closing="@EditProjectModal.CancelClosingModalWhenFocusLost">
    <ModalContent Centered="true">
@*//<suite-custom-code-block-8>*@
@*//</suite-custom-code-block-8>*@
        <Form id="EditProjectForm">
            <ModalHeader>
                <ModalTitle>@L["Update"]</ModalTitle>
                <CloseButton Clicked="CloseEditProjectModalAsync" />
            </ModalHeader>
            <ModalBody>
                @* Manual validation is used (see ValidateEditProject). *@
                @if (!string.IsNullOrWhiteSpace(EditProjectValidationErrorKey))
                {
                    <Alert Color="Color.Danger">
                        <AlertMessage>@L["NotificationError"]!</AlertMessage>
                        <AlertDescription>@L[EditProjectValidationErrorKey]</AlertDescription>
                    </Alert>
                }
                <Form>
                    <Field>
                        <FieldLabel>@L["Code"] *</FieldLabel>
                        <TextEdit Text="@EditingProject.Code"
                                  TextChanged="@((string value) => { EditingProject.Code = value; EditFieldErrors.Remove("Code"); })"
                                  ReadOnly="true"
                                  MaxLength="ProjectConsts.CodeMaxLength" 
                                  Autofocus="true"
                                  Style="@(HasEditFieldError("Code") ? "border-color: #dc3545;" : "")" />
                        @if (HasEditFieldError("Code"))
                        {
                            <div class="invalid-feedback d-block">@GetEditFieldError("Code")</div>
                        }
                    </Field>
                    <Field>
                        <FieldLabel>@L["Name"] *</FieldLabel>
                        <TextEdit Text="@EditingProject.Name" 
                                  TextChanged="@((string value) => { EditingProject.Name = value; EditFieldErrors.Remove("Name"); })"
                                  MaxLength="ProjectConsts.NameMaxLength"
                                  Style="@(HasEditFieldError("Name") ? "border-color: #dc3545;" : "")" />
                        @if (HasEditFieldError("Name"))
                        {
                            <div class="invalid-feedback d-block">@GetEditFieldError("Name")</div>
                        }
                    </Field>
                    <Field>
                        <FieldLabel>@L["Description"]</FieldLabel>
                        <MemoEdit @bind-Text="@EditingProject.Description" />
                    </Field>
                    <Field>
                        <FieldLabel>@L["StartDate"]</FieldLabel>
                        <Addons>
                            <Addon AddonType="AddonType.Body">
                                <DatePicker TValue="DateTime"
                                            InputMode="DateInputMode.DateTime"
                                            Date="@EditingProject.StartDate"
                                            DateChanged="@(v => EditingProject.StartDate = v)"
                                            Placeholder="@string.Empty"
                                            DisplayFormat="dd/MM/yyyy HH:mm"
                                            InputFormat="dd/MM/yyyy HH:mm"
                                            @ref="@EditingProjectStartDateDatePicker" />
                            </Addon>
                            <Addon AddonType="AddonType.End">
                                <Button Color="Color.Light" Clicked="@(() => EditingProjectStartDateDatePicker?.ToggleAsync())">
                                    <Icon Name="IconName.CalendarDay" />
                                </Button>
                            </Addon>
                        </Addons>
                    </Field>
                    <Field>
                        <FieldLabel>@L["EndDate"]</FieldLabel>
                        <Addons>
                            <Addon AddonType="AddonType.Body">
                                <DatePicker TValue="DateTime"
                                            InputMode="DateInputMode.DateTime"
                                            Date="@EditingProject.EndDate"
                                            DateChanged="@(v => EditingProject.EndDate = v)"
                                            Placeholder="@string.Empty"
                                            DisplayFormat="dd/MM/yyyy HH:mm"
                                            InputFormat="dd/MM/yyyy HH:mm"
                                            @ref="@EditingProjectEndDateDatePicker" />
                            </Addon>
                            <Addon AddonType="AddonType.End">
                                <Button Color="Color.Light" Clicked="@(() => EditingProjectEndDateDatePicker?.ToggleAsync())">
                                    <Icon Name="IconName.CalendarDay" />
                                </Button>
                            </Addon>
                        </Addons>
                    </Field>
                    <Field>
                        <FieldLabel>@L["Status"] *</FieldLabel>
                        <Select TValue="ProjectStatus" 
                                SelectedValue="@EditingProject.Status"
                                SelectedValueChanged="@((ProjectStatus value) => { EditingProject.Status = value; })">
                            <ChildContent>
                                @foreach (var status in Enum.GetValues<ProjectStatus>())
                                {
                                    <SelectItem TValue="ProjectStatus" Value="@status">
                                        @L[$"Enum:ProjectStatus.{status}"]
                                    </SelectItem>
                                }
                            </ChildContent>
                        </Select>
                    </Field>
                    <Field>
                        <FieldLabel>@L["Department"]</FieldLabel>
                        <Select2 IdSelector="c => c.Id.ToString()"
                                 TextSelector="c => c.DisplayName"
                                 FilterFunction="GetDepartmentCollectionLookupAsync"
                                 GetElementById="async (items, id, token) => items.FirstOrDefault(x => x.Id.ToString() == id)!"
                                 Datasource="DepartmentsCollection"
                                 Value="@SelectedEditDepartment"
                                 OnValueChanged="OnEditDepartmentIdChanged"
                                 Cache="__MemoryCache"
                                 Multiselect="false" />
                    </Field>

                    <hr />

                    <Field>
                        <FieldLabel>@L["ProjectMembers"]</FieldLabel>
                        @if (!IsProjectMembersTabVisited)
                        {
                            <Button Color="Color.Secondary" Clicked="EnsureEditProjectMembersDataLoadedAsync">
                                @L["SelectProjectMembers"]
                            </Button>
                        }
                        else
                        {
                            <Select2 IdSelector="c => c.Id.ToString()"
                                     TextSelector="c => c.DisplayName"
                                     FilterFunction="GetIdentityUserCollectionLookupAsync"
                                     GetElementById="async (items, id, token) => items.FirstOrDefault(x => x.Id.ToString() == id)!"
                                     Datasource="IdentityUsersCollection"
                                     Value="@SelectedProjectMembers"
                                     ValueChanged="@((List<LookupDto<Guid>> value) => SelectedProjectMembers = value ?? new List<LookupDto<Guid>>())"
                                     Cache="__MemoryCache"
                                     Multiselect="false" />
                        }
                    </Field>
                </Form>
            </ModalBody>
            <ModalFooter>
                <Button Color="Color.Secondary"
                        Clicked="CloseEditProjectModalAsync">
                    @L["Cancel"]
                </Button>
                <Button Color="Color.Primary" Clicked="UpdateProjectAsync">
                    @L["Save"]
                </Button>
@*//<suite-custom-code-block-9>*@
@*//</suite-custom-code-block-9>*@
            </ModalFooter>
        </Form>
@*//<suite-custom-code-block-10>*@
@*//</suite-custom-code-block-10>*@
    </ModalContent>
</Modal>

@code {
    private DatePicker<DateTime>? NewProjectStartDateDatePicker { get; set; }
    private DatePicker<DateTime>? NewProjectEndDateDatePicker { get; set; }
    private DatePicker<DateTime>? EditingProjectStartDateDatePicker { get; set; }
    private DatePicker<DateTime>? EditingProjectEndDateDatePicker { get; set; }
}
