@inherits Volo.Abp.AspNetCore.Components.AbpComponentBase
@implements IAsyncDisposable
@using HC.Notifications
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.Logging
@using Microsoft.JSInterop

@if (_isInitialized)
{
    <div class="notification-toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
        @foreach (var notification in _notifications)
        {
            <div class="toast show mb-2" role="alert" aria-live="assertive" aria-atomic="true" style="min-width: 300px;">
                <div class="toast-header @GetPriorityClass(notification.Priority)">
                    <i class="fas fa-bell me-2"></i>
                    <strong class="me-auto">@notification.Title</strong>
                    <small class="text-muted">@notification.CreationTime.ToString("HH:mm")</small>
                    <button type="button" class="btn-close" @onclick="() => RemoveNotification(notification.Id)" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    @notification.Content
                    @if (!string.IsNullOrEmpty(notification.RelatedId))
                    {
                        <div class="mt-2">
                            <a href="@GetRelatedUrl(notification)" class="btn btn-sm btn-primary">View Details</a>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}

@code {
    private List<NotificationDto> _notifications = new();
    private bool _isInitialized = false;
    private DotNetObjectReference<NotificationToast>? _objRef;

    [Inject] private NavigationManager NavigationManager { get; set; } = null!;
    [Inject] private INotificationsAppService NotificationsAppService { get; set; } = null!;
    [Inject] private ILogger<NotificationToast> NotificationLogger { get; set; } = null!;
    [Inject] private IJSRuntime JS { get; set; } = null!;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        NotificationLogger.LogInformation("[NotificationToast] ðŸ”µ Component OnInitialized called. IsAuthenticated={IsAuthenticated}, UserId={UserId}", 
            CurrentUser.IsAuthenticated, CurrentUser.Id?.ToString() ?? "null");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && CurrentUser.IsAuthenticated)
        {
            NotificationLogger.LogInformation("[NotificationToast] ðŸŸ¢ Component OnAfterRenderAsync (firstRender). IsAuthenticated={IsAuthenticated}, UserId={UserId}", 
                CurrentUser.IsAuthenticated, CurrentUser.Id);
            
            try
            {
                // Create DotNetObjectReference for JavaScript interop
                _objRef = DotNetObjectReference.Create(this);
                
                // Initialize SignalR connection from JavaScript (browser-side)
                // This ensures cookies are sent correctly with the connection
                await JS.InvokeVoidAsync("notificationHub.start", _objRef);
                
                _isInitialized = true;
                NotificationLogger.LogInformation("[NotificationToast] âœ… SignalR connection initialized from JavaScript. IsInitialized={IsInitialized}", _isInitialized);
            }
            catch (Exception ex)
            {
                NotificationLogger.LogError(ex, "[NotificationToast] âŒ Error initializing SignalR connection from JavaScript: Message={Message}", ex.Message);
            }
        }
    }

    [JSInvokable]
    public async Task OnNotificationReceived(string notificationId)
    {
        try
        {
            NotificationLogger.LogInformation("[NotificationToast] âœ… Received notification from SignalR: NotificationId={NotificationId}", notificationId);
            
            if (Guid.TryParse(notificationId, out var guid))
            {
                await LoadNotificationAsync(guid);
                await InvokeAsync(StateHasChanged);
            }
            else
            {
                NotificationLogger.LogWarning("[NotificationToast] âš ï¸ Invalid notification ID format: NotificationId={NotificationId}", notificationId);
            }
        }
        catch (Exception ex)
        {
            NotificationLogger.LogError(ex, "[NotificationToast] âŒ Error handling notification: NotificationId={NotificationId}, Message={Message}", 
                notificationId, ex.Message);
        }
    }

    private async Task LoadNotificationAsync(Guid notificationId)
    {
        try
        {
            NotificationLogger.LogInformation("[NotificationToast] Loading notification: NotificationId={NotificationId}", notificationId);
            var notification = await NotificationsAppService.GetAsync(notificationId);
            if (notification != null)
            {
                NotificationLogger.LogInformation("[NotificationToast] âœ… Notification loaded: NotificationId={NotificationId}, Title={Title}", 
                    notificationId, notification.Title);
                _notifications.Insert(0, notification);
                
                // Auto-remove after 5 seconds
                _ = Task.Run(async () =>
                {
                    await Task.Delay(5000);
                    RemoveNotification(notificationId);
                    await InvokeAsync(StateHasChanged);
                });
            }
            else
            {
                NotificationLogger.LogWarning("[NotificationToast] âš ï¸ Notification not found: NotificationId={NotificationId}", notificationId);
            }
        }
        catch (Exception ex)
        {
            NotificationLogger.LogError(ex, "[NotificationToast] âŒ Error loading notification: NotificationId={NotificationId}, Message={Message}", 
                notificationId, ex.Message);
        }
    }

    private void RemoveNotification(Guid notificationId)
    {
        _notifications.RemoveAll(n => n.Id == notificationId);
    }

    private string GetPriorityClass(string priority)
    {
        return priority?.ToUpper() switch
        {
            "HIGH" => "bg-danger text-white",
            "URGENT" => "bg-danger text-white",
            "NORMAL" => "bg-info text-white",
            "LOW" => "bg-secondary text-white",
            _ => "bg-primary text-white"
        };
    }

    private string GetRelatedUrl(NotificationDto notification)
    {
        if (string.IsNullOrEmpty(notification.RelatedId) || string.IsNullOrEmpty(notification.RelatedType))
            return "#";

        return notification.RelatedType.ToUpper() switch
        {
            "TASK" => $"/project-tasks/{notification.RelatedId}",
            "PROJECT" => $"/projects/{notification.RelatedId}",
            "DOCUMENT" => $"/documents/{notification.RelatedId}",
            _ => "#"
        };
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            // Stop SignalR connection from JavaScript
            if (_isInitialized)
            {
                await JS.InvokeVoidAsync("notificationHub.stop");
                NotificationLogger.LogInformation("[NotificationToast] SignalR connection stopped");
            }
        }
        catch (Exception ex)
        {
            NotificationLogger.LogError(ex, "[NotificationToast] Error stopping SignalR connection: Message={Message}", ex.Message);
        }
        finally
        {
            _objRef?.Dispose();
        }
    }
}
